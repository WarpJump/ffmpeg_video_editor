--- START OF FILE index.html ---

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–í–∏–¥–µ–æ –†–µ–¥–∞–∫—Ç–æ—Ä v26.3 (Final UX)</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <style>
        .modal-backdrop{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:1000} .modal-content{background:#282a36;padding:20px;border-radius:8px;width:90%;max-width:600px;border:1px solid #6272a4} #file-list{height:350px;overflow-y:auto;background:#21222c;padding:5px;margin-bottom:10px;border:1px solid #44475a} .file-entry{cursor:pointer;padding:5px 8px;border-radius:3px} .file-entry:hover{background:#44475a} .file-entry.dir::before{content:'üìÅ '} .file-entry.file::before{content:'üìÑ '} .hidden{display:none} #path-container{display:flex;align-items:center;margin-bottom:10px} #current-path{flex-grow:1;padding:5px;background:#21222c;color:#f8f8f2;border:1px solid #44475a} #up-btn{background:#6272a4;color:#f8f8f2;border:none;padding:5px 10px;margin-left:5px;cursor:pointer} #up-btn:hover{background:#bd93f9} .modal-buttons{display:flex;justify-content:flex-end;gap:10px}
        .video-container { position: relative; width: 100%; background: black; border: 1px solid var(--panel-bg); }
        .video-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .video-container .inactive-player { visibility: hidden; }
    </style>
</head>
<body>
    <h1>–í–∏–¥–µ–æ –†–µ–¥–∞–∫—Ç–æ—Ä v26.3 (Final UX)</h1>
    <div class="container">
        <!-- HTML-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
        <div class="form-column">
            <fieldset><legend>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏</legend><label>–†–µ–∂–∏–º –†–∞–±–æ—Ç—ã:</label><div><input type="radio" id="singleFile" name="mode" value="single" checked onchange="toggleMode()"><label for="singleFile" title="–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–≤–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –∏–∑ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ —Ñ–∞–π–ª–∞.">–û–¥–∏–Ω —Ñ–∞–π–ª</label><input type="radio" id="twoFiles" name="mode" value="two" onchange="toggleMode()"><label for="twoFiles" title="–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–≤–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –∏–∑ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤.">–î–≤–∞ —Ñ–∞–π–ª–∞</label></div><div id="single_segment_toggle_div" style="margin-top:10px;"><input type="checkbox" id="is_single_segment" name="is_single_segment" onchange="toggleMode()"><label for="is_single_segment" title="–í—ã—Ä–µ–∑–∞—Ç—å –æ–¥–∏–Ω –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –∫—É—Å–æ–∫ –∏–∑ –≤–∏–¥–µ–æ, –¥–æ–±–∞–≤–∏–≤ –∏–Ω—Ç—Ä–æ –∏ –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ.">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –µ–¥–∏–Ω—ã–π —Ä–æ–ª–∏–∫</label></div><div style="margin-top:15px;"><input type="checkbox" id="use_ram" checked><label for="use_ram" title="–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –≤ /dev/shm (–û–ó–£). –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ Linux. –£—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å, –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –û–ó–£.">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RAM-–¥–∏—Å–∫</label></div><div style="margin-top:15px;"><label>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏–Ω—Ç—Ä–æ:</label><div><input type="radio" id="intro_fullhd" name="intro_resolution" value="fullhd"> <label for="intro_fullhd">FullHD (1080p)</label><input type="radio" id="intro_2k" name="intro_resolution" value="2k" checked> <label for="intro_2k">2K (1440p)</label></div></div><div style="margin-top:15px;"><label>–í—ã—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è (–æ–ø—Ü–∏—è):</label><button type="button" onclick="selectDirectory('output_dir')">–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É...</button><div id="output_dir_path" class="file-path-display">(–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø–∞–ø–∫–∞ –≤—ã–≤–æ–¥–∞)</div></div></fieldset>
            <fieldset><legend>2. –§–∞–π–ª—ã</legend><button type="button" onclick="selectFile('intro_file')">1. –í—ã–±—Ä–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫ –∏–Ω—Ç—Ä–æ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)</button><div id="intro_file_path" class="file-path-display"></div><button type="button" onclick="selectFile('video1')">2. –í—ã–±—Ä–∞—Ç—å –í–∏–¥–µ–æ 1</button><div id="video1_path" class="file-path-display"></div><div id="video2_container" class="hidden"><button type="button" onclick="selectFile('video2')">3. –í—ã–±—Ä–∞—Ç—å –í–∏–¥–µ–æ 2</button><div id="video2_path" class="file-path-display"></div></div><button type="button" onclick="selectFile('audio1')">–ê—É–¥–∏–æ 1 (–æ–ø—Ü–∏—è)...</button><div id="audio1_path" class="file-path-display"></div><div id="audio2_container" class="hidden"><button type="button" onclick="selectFile('audio2')">–ê—É–¥–∏–æ 2 (–æ–ø—Ü–∏—è)...</button><div id="audio2_path" class="file-path-display"></div></div></fieldset>
            <fieldset><legend>3. –¢–∞–π–º–∫–æ–¥—ã</legend><h4>–°–µ–≥–º–µ–Ω—Ç 1</h4><div class="time-input-group"><label for="start1" style="width:60px;">–ù–∞—á–∞–ª–æ:</label> <input type="text" id="start1" placeholder="00:01:10"><button class="jump-btn" onclick="jumpToTime('start1')">‚ñ∂</button></div><div class="time-input-group"><label for="end1" style="width:60px;">–ö–æ–Ω–µ—Ü:</label> <input type="text" id="end1" placeholder="00:45:30"><button class="jump-btn" onclick="jumpToTime('end1')">‚ñ∂</button></div><div id="part2_timecodes"><hr style="border-color: var(--panel-bg);"><h4>–°–µ–≥–º–µ–Ω—Ç 2</h4><div class="time-input-group"><label for="start2" style="width:60px;">–ù–∞—á–∞–ª–æ:</label> <input type="text" id="start2" placeholder="00:00:15"><button class="jump-btn" onclick="jumpToTime('start2')">‚ñ∂</button></div><div class="time-input-group"><label for="end2" style="width:60px;">–ö–æ–Ω–µ—Ü:</label> <input type="text" id="end2" placeholder="00:30:00"><button class="jump-btn" onclick="jumpToTime('end2')">‚ñ∂</button></div></div></fieldset>
            <button type="button" id="submitBtn" class="action-btn" onclick="submitForm()">–ù–∞—á–∞—Ç—å –û–±—Ä–∞–±–æ—Ç–∫—É</button>
        </div>
        <div class="preview-column">
            <h2>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
            <div id="video-container" class="video-container">
                <video id="videoPlayerA" playsinline preload="auto"></video>
                <video id="videoPlayerB" class="inactive-player" playsinline preload="auto"></video>
            </div>
            <div class="virtual-player-container" id="virtual-player">
                <div class="virtual-player-controls">
                    <button id="v-play-btn">‚ñ∂</button>
                    <span id="v-time-display">00:00:00 / 00:00:00</span>
                    <input type="range" id="v-progress-bar" min="0" max="100" value="0">
                </div>
            </div>
            <h2>–õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h2>
            <pre id="log-output">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É...</pre>
        </div>
    </div>
    <div id="file-modal" class="modal-backdrop hidden"><div class="modal-content"><h3>–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞</h3><div id="path-container"><input id="current-path" type="text" value="/"><button id="up-btn" title="–í–≤–µ—Ä—Ö">‚Üë</button></div><div id="file-list">(–ø—É—Å—Ç–æ)</div><div class="modal-buttons"><button id="close-btn">–ó–∞–∫—Ä—ã—Ç—å</button><button id="select-dir-btn" class="hidden" style="background: var(--accent-green);">–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É</button></div></div></div>
    
    <script>
        const SERVER_PORT = "%%SERVER_PORT%%";
        const logOutput = document.getElementById('log-output');
        let filePaths = { video1: '', video2: '', audio1: '', audio2: '', intro_file: '', output_dir: '' };
        let ws;
        let currentId = '';

        const FRAGMENT_DURATION = 10;
        const PRELOAD_SECONDS = 5;

        let currentFragment = { start: -1, duration: 0 };
        let totalFinalDuration = 0;
        let virtualPlayerState = { isPlaying: false, currentTime: 0, isSeeking: false };
        let lastProcessingParams = {};
        let activePlayer, hiddenPlayer;
        let lastRequestedTime = -1;
        let lastPreloadTime = -1;

        function logDebug(message, ...args) { console.log(`[PLAYER DEBUG @ ${new Date().toLocaleTimeString()}] ${message}`, ...args); }
        function swapPlayers() { logDebug(`--- SWAP PLAYERS: ${activePlayer.id} -> ${hiddenPlayer.id} ---`); [activePlayer, hiddenPlayer] = [hiddenPlayer, activePlayer]; activePlayer.classList.remove('inactive-player'); hiddenPlayer.classList.add('inactive-player'); hiddenPlayer.src = ''; }
        function hmsToSeconds(str) { if (!str) return 0; const p = str.split(':').map(Number); let s = 0; if (p.length === 3) s = p[0] * 3600 + p[1] * 60 + p[2]; else if (p.length === 2) s = p[0] * 60 + p[1]; else if (p.length === 1 && str) s = parseFloat(str); return isNaN(s) ? 0 : s; }
        function secondsToHMS(s) { s = s || 0; const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); const sec = Math.floor(s % 60); return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`; }
        
        function jumpToTime(id) {
            const input = document.getElementById(id); const time = hmsToSeconds(input.value);
            const videoKey = id.includes('2') ? 'video2' : 'video1';
            const videoPath = filePaths[videoKey];
            if (isNaN(time) || !videoPath) return;

            virtualPlayerState.isPlaying = false; document.getElementById('v-play-btn').textContent = '‚ñ∂';
            activePlayer.pause(); hiddenPlayer.pause();
            const relativeVideoPath = filePaths[videoKey + '_relative'] || videoPath;
            activePlayer.src = `http://127.0.0.1:${SERVER_PORT}/video?path=${encodeURIComponent(relativeVideoPath)}`;
            activePlayer.oncanplaythrough = () => { activePlayer.currentTime = time; activePlayer.play(); activePlayer.oncanplaythrough = null; };
        }
        
        function updateTimeDisplay() {
            document.getElementById('v-time-display').textContent = `${secondsToHMS(virtualPlayerState.currentTime)} / ${secondsToHMS(totalFinalDuration)}`;
            document.getElementById('v-progress-bar').value = virtualPlayerState.currentTime;
        }

        function requestPreviewFragment(globalTime, isPreload = false) {
            globalTime = Math.max(0, globalTime);
            const roundedStart = Math.floor(globalTime / FRAGMENT_DURATION) * FRAGMENT_DURATION;
            
            if (isPreload && (lastPreloadTime === roundedStart || lastRequestedTime === roundedStart)) return;
            if (!isPreload && lastRequestedTime === roundedStart && activePlayer.src) return;

            if (isPreload) {
                lastPreloadTime = roundedStart;
            } else {
                lastRequestedTime = roundedStart;
                lastPreloadTime = -1;
                hiddenPlayer.src = '';
            }
            
            logDebug(`REQUEST fragment from ${secondsToHMS(roundedStart)}. Preload: ${isPreload}.`);
            ws.send(JSON.stringify({ action: "generate_preview_fragment", start_time: roundedStart, params: lastProcessingParams }));
        }

        function onPreviewFragmentReady(data) {
            const receivedTime = data.start_time;
            const url = `http://127.0.0.1:${SERVER_PORT}/video?path=${encodeURIComponent(data.relative_path)}`;
            
            if (lastRequestedTime === receivedTime) {
                logDebug(`RECEIVED fragment for ACTIVE player at ${secondsToHMS(receivedTime)}.`);
                currentFragment = { start: data.start_time, duration: data.duration };
                activePlayer.src = url;
                const seekTo = Math.max(0, virtualPlayerState.currentTime - data.start_time);
                activePlayer.currentTime = seekTo;
                if (virtualPlayerState.isPlaying) { activePlayer.play().catch(console.error); }
            } else if (lastPreloadTime === receivedTime) {
                logDebug(`RECEIVED fragment for HIDDEN player at ${secondsToHMS(receivedTime)}.`);
                hiddenPlayer.src = url;
            } else {
                logDebug(`RECEIVED STALE fragment for ${secondsToHMS(receivedTime)}. Ignoring.`);
            }
        }

        function onPreviewMapReady(data) {
            totalFinalDuration = data.total_duration;
            document.getElementById('v-progress-bar').max = totalFinalDuration;
            virtualPlayerState.currentTime = 0;
            updateTimeDisplay();
            document.getElementById('virtual-player').style.display = 'block';
            currentFragment = { start: -1, duration: 0 };
            requestPreviewFragment(0);
        }

        function gatherCurrentParams() { lastProcessingParams = { use_ram: document.getElementById('use_ram').checked, mode: document.querySelector('input[name="mode"]:checked').value, is_single_segment: document.getElementById('is_single_segment').checked, intro_resolution: document.querySelector('input[name="intro_resolution"]:checked').value, start1: document.getElementById('start1').value, end1: document.getElementById('end1').value, start2: document.getElementById('start2').value, end2: document.getElementById('end2').value, output_dir: filePaths.output_dir, ...filePaths }; return lastProcessingParams; }
        function requestPreviewMap() { if (ws && ws.readyState === WebSocket.OPEN && filePaths.video1) { logOutput.textContent += '\n–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞—Ä—Ç—É –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞...\n'; gatherCurrentParams(); ws.send(JSON.stringify({ action: 'generate_preview_map', params: lastProcessingParams })); } }
        function submitForm() { if (!ws || ws.readyState !== WebSocket.OPEN || !filePaths.video1) return; document.getElementById('submitBtn').disabled = true; document.getElementById('submitBtn').textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...'; logOutput.textContent = '–ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å–±–æ—Ä–∫—É...\n'; ws.send(JSON.stringify({ action: 'process', params: gatherCurrentParams() })); }
        function sendMessage(action, path, id) { ws.send(JSON.stringify({ action, path, id })); }
        function connect() { ws = new WebSocket(`ws://127.0.0.1:${SERVER_PORT}`); ws.onopen = () => { logOutput.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.\n'; setTimeout(requestPreviewMap, 500); }; ws.onerror = () => { logOutput.textContent += '–û—à–∏–±–∫–∞ WS.\n'; }; ws.onclose = () => { setTimeout(connect, 2000); }; ws.onmessage = (event) => { const data = JSON.parse(event.data); switch(data.action) { case 'log': if (data.message.startsWith('frame=')) { const lines = logOutput.textContent.split('\n'); if (lines.length > 1 && lines[lines.length - 2].startsWith('frame=')) { lines[lines.length - 2] = data.message; logOutput.textContent = lines.join('\n'); } else { logOutput.textContent += data.message + '\n'; } } else { logOutput.textContent += data.message + '\n'; } logOutput.scrollTop = logOutput.scrollHeight; break; case 'finished': document.getElementById('submitBtn').disabled = false; document.getElementById('submitBtn').textContent = '–ù–∞—á–∞—Ç—å –û–±—Ä–∞–±–æ—Ç–∫—É'; break; case 'browse_result': renderBrowser(data); break; case 'path_resolved': if (data.full_path) { filePaths[currentId] = data.full_path; if(data.relative_path) { filePaths[currentId + '_relative'] = data.relative_path; } document.getElementById(currentId + '_path').textContent = data.full_path; if (currentId === 'video1' || currentId === 'video2') requestPreviewMap(); } document.getElementById('file-modal').classList.add('hidden'); document.getElementById('select-dir-btn').classList.add('hidden'); saveState(); break; case 'error': logOutput.textContent += `\n–û–®–ò–ë–ö–ê: ${data.message}\n`; lastRequestedTime = lastPreloadTime = -1; break; case 'preview_map_ready': onPreviewMapReady(data); break; case 'preview_fragment_ready': onPreviewFragmentReady(data); break; } }; }
        function renderBrowser(data) { const fileList = document.getElementById('file-list'); document.getElementById('current-path').value = data.path; fileList.innerHTML = ''; let html = ''; if (data.path !== '/') { const parentPath = data.path.substring(0, data.path.lastIndexOf('/')) || '/'; html += `<div class="file-entry dir" data-path="${parentPath}">.. (–ù–∞–≤–µ—Ä—Ö)</div>`; } html += (data.entries || []).map(e => `<div class="file-entry ${e.type}" data-path="${(data.path === '/' ? '' : data.path) + '/' + e.name}">${e.name}</div>`).join(''); fileList.innerHTML = html || '(–ø—É—Å—Ç–æ)'; }
        function goUp() { const p = document.getElementById('current-path').value; if (p !== '/') sendMessage('browse_path', p.substring(0, p.lastIndexOf('/')) || '/', currentId); }
        function openModal(id) { currentId = id; document.getElementById('file-modal').classList.remove('hidden'); document.getElementById('file-list').innerHTML = '(–∑–∞–≥—Ä—É–∑–∫–∞...)'; sendMessage('browse_path', '/', currentId); }
        function selectFile(id) { if (!ws || ws.readyState !== WebSocket.OPEN) return; document.getElementById('select-dir-btn').classList.add('hidden'); openModal(id); }
        function selectDirectory(id) { document.getElementById('select-dir-btn').classList.remove('hidden'); openModal(id); }
        function toggleMode() { const isSingleFile = document.getElementById('singleFile').checked; const isSingleSeg = document.getElementById('is_single_segment').checked; document.getElementById('video2_container').style.display = isSingleFile ? 'none' : 'block'; document.getElementById('audio2_container').style.display = isSingleFile ? 'none' : 'block'; document.getElementById('single_segment_toggle_div').style.display = isSingleFile ? 'block' : 'none'; document.getElementById('part2_timecodes').style.display = !isSingleFile || (isSingleFile && !isSingleSeg) ? 'block' : 'none'; saveState(); requestPreviewMap(); }
        function saveState() { const state = { filePaths, start1: document.getElementById('start1').value, end1: document.getElementById('end1').value, start2: document.getElementById('start2').value, end2: document.getElementById('end2').value, mode: document.querySelector('input[name="mode"]:checked').value, is_single_segment: document.getElementById('is_single_segment').checked, use_ram: document.getElementById('use_ram').checked, intro_resolution: document.querySelector('input[name="intro_resolution"]:checked').value }; localStorage.setItem('videoEditorState', JSON.stringify(state)); }
        function loadState() { const saved = localStorage.getItem('videoEditorState'); if (saved) { const state = JSON.parse(saved); filePaths = { ...filePaths, ...state.filePaths }; document.getElementById('start1').value = state.start1 || ''; document.getElementById('end1').value = state.end1 || ''; document.getElementById('start2').value = state.start2 || ''; document.getElementById('end2').value = state.end2 || ''; document.querySelector(`input[name="mode"][value="${state.mode || 'single'}"]`).checked = true; document.getElementById('is_single_segment').checked = state.is_single_segment || false; document.getElementById('use_ram').checked = state.use_ram !== false; document.querySelector(`input[name="intro_resolution"][value="${state.intro_resolution || '2k'}"]`).checked = true; Object.keys(filePaths).forEach(key => { if (filePaths[key] && !key.endsWith('_relative')) document.getElementById(key + '_path').textContent = filePaths[key]; }); } }

        window.onload = () => {
            loadState(); connect(); toggleMode();
            activePlayer = document.getElementById('videoPlayerA'); hiddenPlayer = document.getElementById('videoPlayerB');
            const vPlayBtn = document.getElementById('v-play-btn'); const vProgressBar = document.getElementById('v-progress-bar');
            
            [activePlayer, hiddenPlayer].forEach(p => {
                p.addEventListener('timeupdate', () => {
                    if (p !== activePlayer || virtualPlayerState.isSeeking) return;
                    virtualPlayerState.currentTime = currentFragment.start + p.currentTime;
                    document.getElementById('v-time-display').textContent = `${secondsToHMS(virtualPlayerState.currentTime)} / ${secondsToHMS(totalFinalDuration)}`;
                    if(!virtualPlayerState.isSeeking) { vProgressBar.value = virtualPlayerState.currentTime; }
                    if (p.duration > 0 && p.duration - p.currentTime < PRELOAD_SECONDS) {
                        const nextStart = currentFragment.start + FRAGMENT_DURATION;
                        if (nextStart < totalFinalDuration) { requestPreviewFragment(nextStart, true); }
                    }
                });
                p.addEventListener('ended', () => {
                    if (p !== activePlayer || !virtualPlayerState.isPlaying) return;
                    logDebug(`ENDED event for ${activePlayer.id}.`);
                    const nextFragmentStart = currentFragment.start + FRAGMENT_DURATION;
                    if (nextFragmentStart >= totalFinalDuration) { virtualPlayerState.isPlaying = false; vPlayBtn.textContent = '‚ñ∂'; return; }
                    const swapAndPlay = () => { currentFragment.start = nextFragmentStart; currentFragment.duration = hiddenPlayer.duration; swapPlayers(); activePlayer.play().catch(e => { logDebug(`Error playing swapped player: ${e.message}`); virtualPlayerState.isPlaying = false; vPlayBtn.textContent = '‚ñ∂'; }); };
                    if (hiddenPlayer.readyState >= 3 && hiddenPlayer.src) { logDebug('Hidden player is READY. Swapping immediately.'); swapAndPlay(); } 
                    else { logDebug('Hidden player is NOT READY. Waiting...'); hiddenPlayer.oncanplay = () => { logDebug('Hidden player is now ready (oncanplay). Swapping.'); swapAndPlay(); hiddenPlayer.oncanplay = null; }; }
                });
                p.addEventListener('loadedmetadata', () => { const container = document.getElementById('video-container'); const ar = p.videoWidth / p.videoHeight; container.style.height = `${container.clientWidth / ar}px`; });
            });

            vPlayBtn.addEventListener('click', () => { virtualPlayerState.isPlaying = !virtualPlayerState.isPlaying; vPlayBtn.textContent = virtualPlayerState.isPlaying ? '‚è∏' : '‚ñ∂'; if (virtualPlayerState.isPlaying) { if (activePlayer.src) activePlayer.play().catch(console.error); else requestPreviewFragment(virtualPlayerState.currentTime); } else { activePlayer.pause(); } });
            
            // ### –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–º–æ—Ç–∫–∏ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞ ###
            vProgressBar.addEventListener('mousedown', () => {
                virtualPlayerState.isSeeking = true;
            });
            vProgressBar.addEventListener('input', (e) => {
                // –ü–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–∞—â–∏—Ç –ø–æ–ª–∑—É–Ω–æ–∫, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –∏ –Ω–∞—à–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                if (virtualPlayerState.isSeeking) {
                    virtualPlayerState.currentTime = parseFloat(e.target.value);
                    document.getElementById('v-time-display').textContent = `${secondsToHMS(virtualPlayerState.currentTime)} / ${secondsToHMS(totalFinalDuration)}`;
                }
            });
            vProgressBar.addEventListener('change', (e) => {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—É—Å—Ç–∏–ª –ø–æ–ª–∑—É–Ω–æ–∫. –≠—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞.
                // 1. –§–∏–∫—Å–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                virtualPlayerState.isSeeking = false;
                virtualPlayerState.currentTime = parseFloat(e.target.value);
                logDebug(`SEEK TO: ${secondsToHMS(virtualPlayerState.currentTime)}`);

                // 2. –ù–ï–ú–ï–î–õ–ï–ù–ù–û –æ–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å—å UI (–ø–æ–ª–∑—É–Ω–æ–∫ –∏ —Ç–µ–∫—Å—Ç)
                // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ–ª–∑—É–Ω–æ–∫ "–ø–µ—Ä–µ–ø—Ä—ã–≥–Ω–µ—Ç" –≤ –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é —Å—Ä–∞–∑—É –∂–µ.
                updateTimeDisplay(); 

                // 3. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª—é–±–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏ –æ—á–∏—â–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏
                activePlayer.pause();
                hiddenPlayer.pause();
                activePlayer.src = '';
                hiddenPlayer.src = '';
                
                // 4. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–µ—Ç–∫–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
                lastRequestedTime = -1;
                lastPreloadTime = -1;

                // 5. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–ª—è —ç—Ç–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏
                requestPreviewFragment(virtualPlayerState.currentTime);
            });
            
            ['start1', 'end1', 'start2', 'end2'].forEach(id => { document.getElementById(id).addEventListener('change', () => { saveState(); requestPreviewMap(); }); });
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => input.addEventListener('change', () => { saveState(); if (input.name === 'mode' || input.name === 'is_single_segment' || input.name === 'intro_resolution') { requestPreviewMap(); } }));
            document.getElementById('close-btn').onclick = () => document.getElementById('file-modal').classList.add('hidden');
            document.getElementById('up-btn').onclick = goUp;
            document.getElementById('select-dir-btn').onclick = () => { sendMessage('resolve_path', document.getElementById('current-path').value, currentId); };
            document.getElementById('current-path').onkeydown = (e) => { if (e.key === 'Enter') sendMessage('browse_path', e.target.value, currentId); };
            document.getElementById('file-list').onclick = (e) => { const t = e.target.closest('.file-entry'); if (t) { if (t.classList.contains('dir')) sendMessage('browse_path', t.dataset.path, currentId); else if (!document.getElementById('select-dir-btn').classList.contains('hidden')) return; else sendMessage('resolve_path', t.dataset.path, currentId); } };
        };
    </script>
</body>
</html>