<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–í–∏–¥–µ–æ –†–µ–¥–∞–∫—Ç–æ—Ä v26.6 (Bright Blue)</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <style>
        /* KDE Breeze Dark Inspired Variables + Bright Pop */
        :root { 
            --main-bg: #232629; 
            --main-fg: #eff0f1; 
            --panel-bg: #31363b; 
            --border-color: #616569; 
            --accent-primary: #00bbff; /* BRIGHTER Electric Blue */
            --accent-hover: #5ce4ff; 
            --accent-secondary: #007acc;
            --log-bg: #1b1e20;
            --highlight: #00bbff;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--main-bg); color: var(--main-fg); max-width: 1200px; margin: 2em auto; padding: 1em; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; }
        .form-column { flex: 1; min-width: 400px; } 
        .preview-column { flex: 2; min-width: 400px; }
        
        h1, h2 { color: var(--accent-primary); border-bottom: 2px solid var(--panel-bg); margin-bottom: 15px; font-weight: normal; text-shadow: 0 0 5px rgba(0, 187, 255, 0.2); }
        
        input[type="text"] { flex-grow: 1; padding: 8px; background: var(--log-bg); color: var(--main-fg); border: 1px solid var(--border-color); border-radius: 2px; box-sizing: border-box; }
        input[type="text"]:focus { border-color: var(--accent-primary); outline: none; box-shadow: 0 0 3px var(--accent-primary); }

        button { background-color: var(--panel-bg); color: var(--main-fg); border: 1px solid var(--border-color); padding: 8px; border-radius: 2px; cursor: pointer; transition: all 0.2s; width: 100%; margin-bottom: 10px; }
        button:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        
        button.action-btn { background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary)); color: white; padding: 15px; font-size: 1.1em; border: none; font-weight: bold; }
        button.action-btn:hover { filter: brightness(1.2); }
        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .jump-btn { background: var(--panel-bg); width: 40px; height: 36px; font-size: 1.2em; padding: 0; margin-left: 5px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .jump-btn:hover { background: var(--accent-primary); color: #1b1e20; }

        label { color: #a4a4a4; } 
        legend { color: var(--accent-primary); font-weight: bold; }
        fieldset { border: 1px solid var(--border-color); margin-bottom: 15px; background: #2a2e32; padding: 15px; border-radius: 4px;}

        #log-output { background: var(--log-bg); border: 1px solid var(--border-color); height: 400px; overflow-y: scroll; white-space: pre-wrap; font-family: 'Consolas', monospace; color: #ccc; padding: 10px; font-size: 0.9em; }

        .hidden { display: none !important; }
        .time-input-group { display: flex; align-items: center; margin-bottom: 10px; }
        .file-path-display { padding: 8px; background: var(--log-bg); border-radius: 2px; min-height: 1.2em; word-break: break-all; margin-top: 5px; margin-bottom: 10px; font-size: 0.85em; color: #888; border: 1px dashed var(--border-color); }

        /* Modal */
        .modal-backdrop{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:1000} 
        .modal-content{background:var(--panel-bg);padding:20px;border-radius:4px;width:90%;max-width:600px;border:1px solid var(--accent-primary); box-shadow: 0 0 20px rgba(0, 187, 255, 0.15); } 
        #file-list{height:350px;overflow-y:auto;background:var(--log-bg);padding:5px;margin-bottom:10px;border:1px solid var(--border-color)} 
        .file-entry{cursor:pointer;padding:6px 8px;border-radius:2px; color: var(--main-fg);} 
        .file-entry:hover{background:rgba(0, 187, 255, 0.15); color: var(--accent-primary);} 
        .file-entry.dir::before{content:'üìÅ '; color: var(--accent-primary);} 
        .file-entry.file::before{content:'üìÑ '; opacity: 0.7;} 
        #path-container{display:flex;align-items:center;margin-bottom:10px} 
        #up-btn{width: auto; margin: 0 0 0 5px;} 
        .modal-buttons{display:flex;justify-content:flex-end;gap:10px}

        /* --- FIX: Video Player Full Width --- */
        .video-container { 
            position: relative; 
            width: 100%; 
            /* –£–±—Ä–∞–ª–∏ min-height –∏ flex center, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ö–ª–æ–ø—ã–≤–∞–ª—Å—è —Ç–æ—á–Ω–æ –ø–æ –≤–∏–¥–µ–æ */
            background: black; 
            border: 1px solid var(--border-color); 
            line-height: 0; /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã —Å–Ω–∏–∑—É inline-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        }
        .video-container video { 
            position: relative; /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –ø–æ—Ç–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞ */
            width: 100%; 
            height: auto; /* –í—ã—Å–æ—Ç–∞ –∞–≤—Ç–æ - –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, —à–∏—Ä–∏–Ω–∞ 100% */
            display: block;
        }
        /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π –ø–ª–µ–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –∑–∞–Ω–∏–º–∞–ª –º–µ—Å—Ç–æ */
        .video-container .inactive-player { 
            display: none !important; 
        }
        
        #loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); color: var(--accent-primary);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1.2em; font-weight: bold; z-index: 10;
            display: none;
        }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent-primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .virtual-player-container { background: var(--panel-bg); padding: 15px; border: 1px solid var(--border-color); border-top: none; display: none; }
        .virtual-player-controls { display: flex; align-items: center; gap: 15px; }
        
        #v-play-btn { background: var(--accent-primary); color: #000; width: 40px; height: 40px; font-size: 1.2em; padding: 0; flex-shrink: 0; margin: 0; border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(0, 187, 255, 0.4);}
        #v-play-btn:hover { background: var(--accent-hover); transform: scale(1.05); }

        #v-time-display { font-family: 'Consolas', monospace; font-size: 1.1em; color: var(--main-fg); min-width: 160px; text-align: center;}

        #v-progress-bar { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: var(--log-bg); border-radius: 3px; outline: none; cursor: pointer; }
        #v-progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: var(--accent-primary); border-radius: 50%; cursor: pointer; transition: transform 0.1s; box-shadow: 0 0 10px rgba(0, 187, 255, 0.6); }
        #v-progress-bar::-webkit-slider-thumb:hover { transform: scale(1.3); }
    </style>
</head>
<body>
    <h1>–í–∏–¥–µ–æ –†–µ–¥–∞–∫—Ç–æ—Ä v26.6 (Bright Blue)</h1>
    <div class="container">
        <div class="form-column">
            <fieldset><legend>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏</legend><label>–†–µ–∂–∏–º –†–∞–±–æ—Ç—ã:</label><div><input type="radio" id="singleFile" name="mode" value="single" checked onchange="toggleMode()"><label for="singleFile">–û–¥–∏–Ω —Ñ–∞–π–ª</label><input type="radio" id="twoFiles" name="mode" value="two" onchange="toggleMode()"><label for="twoFiles">–î–≤–∞ —Ñ–∞–π–ª–∞</label></div><div id="single_segment_toggle_div" style="margin-top:10px;"><input type="checkbox" id="is_single_segment" name="is_single_segment" onchange="toggleMode()"><label for="is_single_segment">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –µ–¥–∏–Ω—ã–π —Ä–æ–ª–∏–∫</label></div><div style="margin-top:15px;"><input type="checkbox" id="use_ram" checked><label for="use_ram">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RAM-–¥–∏—Å–∫ (/dev/shm)</label></div><div style="margin-top:15px;"><label>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏–Ω—Ç—Ä–æ:</label><div><input type="radio" id="intro_fullhd" name="intro_resolution" value="fullhd"> <label for="intro_fullhd">FullHD</label><input type="radio" id="intro_2k" name="intro_resolution" value="2k" checked> <label for="intro_2k">2K</label></div></div><div style="margin-top:15px;"><label>–í—ã—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:</label><button type="button" onclick="selectDirectory('output_dir')">–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É...</button><div id="output_dir_path" class="file-path-display">(–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é)</div></div></fieldset>
            <fieldset><legend>2. –§–∞–π–ª—ã</legend><button type="button" onclick="selectFile('intro_file')">1. –í—ã–±—Ä–∞—Ç—å –∏–Ω—Ç—Ä–æ (–æ–ø—Ü–∏—è)</button><div id="intro_file_path" class="file-path-display"></div><button type="button" onclick="selectFile('video1')">2. –í—ã–±—Ä–∞—Ç—å –í–∏–¥–µ–æ 1</button><div id="video1_path" class="file-path-display"></div><div id="video2_container" class="hidden"><button type="button" onclick="selectFile('video2')">3. –í—ã–±—Ä–∞—Ç—å –í–∏–¥–µ–æ 2</button><div id="video2_path" class="file-path-display"></div></div><button type="button" onclick="selectFile('audio1')">–ê—É–¥–∏–æ 1 (–æ–ø—Ü–∏—è)...</button><div id="audio1_path" class="file-path-display"></div><div id="audio2_container" class="hidden"><button type="button" onclick="selectFile('audio2')">–ê—É–¥–∏–æ 2 (–æ–ø—Ü–∏—è)...</button><div id="audio2_path" class="file-path-display"></div></div></fieldset>
            <fieldset><legend>3. –¢–∞–π–º–∫–æ–¥—ã</legend><h4>–°–µ–≥–º–µ–Ω—Ç 1</h4><div class="time-input-group"><label for="start1" style="width:60px;">–ù–∞—á–∞–ª–æ:</label> <input type="text" id="start1" placeholder="00:01:10"><button class="jump-btn" onclick="jumpToTime('start1')">‚ñ∂</button></div><div class="time-input-group"><label for="end1" style="width:60px;">–ö–æ–Ω–µ—Ü:</label> <input type="text" id="end1" placeholder="00:45:30"><button class="jump-btn" onclick="jumpToTime('end1')">‚ñ∂</button></div><div id="part2_timecodes"><hr style="border-color: var(--border-color); opacity: 0.3;"><h4>–°–µ–≥–º–µ–Ω—Ç 2</h4><div class="time-input-group"><label for="start2" style="width:60px;">–ù–∞—á–∞–ª–æ:</label> <input type="text" id="start2" placeholder="00:00:15"><button class="jump-btn" onclick="jumpToTime('start2')">‚ñ∂</button></div><div class="time-input-group"><label for="end2" style="width:60px;">–ö–æ–Ω–µ—Ü:</label> <input type="text" id="end2" placeholder="00:30:00"><button class="jump-btn" onclick="jumpToTime('end2')">‚ñ∂</button></div></div></fieldset>
            <button type="button" id="submitBtn" class="action-btn" onclick="submitForm()">–ù–∞—á–∞—Ç—å –û–±—Ä–∞–±–æ—Ç–∫—É</button>
        </div>
        <div class="preview-column">
            <h2>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
            <div id="video-container" class="video-container">
                <div id="loading-overlay"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <video id="videoPlayerA" playsinline preload="auto"></video>
                <video id="videoPlayerB" class="inactive-player" playsinline preload="auto"></video>
            </div>
            <div class="virtual-player-container" id="virtual-player">
                <div class="virtual-player-controls">
                    <button id="v-play-btn">‚ñ∂</button>
                    <span id="v-time-display">00:00:00 / 00:00:00</span>
                    <input type="range" id="v-progress-bar" min="0" max="100" value="0">
                </div>
            </div>
            <h2>–õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h2>
            <pre id="log-output">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</pre>
        </div>
    </div>
    <div id="file-modal" class="modal-backdrop hidden"><div class="modal-content"><h3>–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞</h3><div id="path-container"><input id="current-path" type="text" value="/"><button id="up-btn" title="–í–≤–µ—Ä—Ö">‚Üë</button></div><div id="file-list">(–ø—É—Å—Ç–æ)</div><div class="modal-buttons"><button id="close-btn">–ó–∞–∫—Ä—ã—Ç—å</button><button id="select-dir-btn" class="hidden" style="background: var(--accent-secondary); color: white; border: none;">–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É</button></div></div></div>
    
    <script>
        const SERVER_PORT = "%%SERVER_PORT%%";
        const logOutput = document.getElementById('log-output');
        let filePaths = { video1: '', video2: '', audio1: '', audio2: '', intro_file: '', output_dir: '' };
        let ws;
        let currentId = '';

        const FRAGMENT_DURATION = 10;
        const PRELOAD_SECONDS = 5;

        let currentFragment = { start: -1, duration: 0 };
        let totalFinalDuration = 0;
        let virtualPlayerState = { isPlaying: false, currentTime: 0, isSeeking: false, isWaitingForFragment: false };
        let lastProcessingParams = {};
        let activePlayer, hiddenPlayer;
        let lastRequestedTime = -1;
        let lastPreloadTime = -1;

        function logDebug(message, ...args) { console.log(`[PLAYER] ${message}`, ...args); }
        function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        
        function swapPlayers() { 
            [activePlayer, hiddenPlayer] = [hiddenPlayer, activePlayer]; 
            activePlayer.classList.remove('inactive-player'); 
            hiddenPlayer.classList.add('inactive-player'); 
            hiddenPlayer.src = ''; 
        }

        function hmsToSeconds(str) { if (!str) return 0; const p = str.split(':').map(Number); let s = 0; if (p.length === 3) s = p[0] * 3600 + p[1] * 60 + p[2]; else if (p.length === 2) s = p[0] * 60 + p[1]; else if (p.length === 1 && str) s = parseFloat(str); return isNaN(s) ? 0 : s; }
        function secondsToHMS(s) { s = s || 0; const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); const sec = Math.floor(s % 60); return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`; }
        
        function jumpToTime(id) {
            const input = document.getElementById(id); const time = hmsToSeconds(input.value);
            if (filePaths.video1) {
                virtualPlayerState.currentTime = time;
                updateTimeDisplay();
                document.getElementById('v-progress-bar').value = time;
                handleSeek(time);
            }
        }
        
        function updateTimeDisplay() {
            document.getElementById('v-time-display').textContent = `${secondsToHMS(virtualPlayerState.currentTime)} / ${secondsToHMS(totalFinalDuration)}`;
        }

        function requestPreviewFragment(globalTime, isPreload = false) {
            globalTime = Math.max(0, globalTime);
            const roundedStart = Math.floor(globalTime / FRAGMENT_DURATION) * FRAGMENT_DURATION;
            
            if (isPreload && (lastPreloadTime === roundedStart || lastRequestedTime === roundedStart)) return;
            if (!isPreload && lastRequestedTime === roundedStart && activePlayer.src) return;

            if (isPreload) {
                lastPreloadTime = roundedStart;
            } else {
                lastRequestedTime = roundedStart;
                lastPreloadTime = -1;
                hiddenPlayer.src = '';
                showLoading(true);
            }
            ws.send(JSON.stringify({ action: "generate_preview_fragment", start_time: roundedStart, params: lastProcessingParams }));
        }

        function onPreviewFragmentReady(data) {
            const receivedTime = data.start_time;
            const url = `http://127.0.0.1:${SERVER_PORT}/video?path=${encodeURIComponent(data.relative_path)}`;
            
            if (lastRequestedTime === receivedTime) {
                showLoading(false);
                
                // –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª–∑—É–Ω–∫–∞ - –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ
                virtualPlayerState.isWaitingForFragment = false;

                currentFragment = { start: data.start_time, duration: data.duration };
                activePlayer.src = url;
                const seekTo = Math.max(0, virtualPlayerState.currentTime - data.start_time);
                
                const playIfEnabled = () => {
                    if (virtualPlayerState.isPlaying) activePlayer.play().catch(console.error);
                };

                if(activePlayer.readyState >= 1) {
                    activePlayer.currentTime = seekTo;
                    playIfEnabled();
                } else {
                    activePlayer.onloadedmetadata = () => {
                        activePlayer.currentTime = seekTo;
                        playIfEnabled();
                        activePlayer.onloadedmetadata = null;
                    };
                }

            } else if (lastPreloadTime === receivedTime) {
                hiddenPlayer.src = url;
            }
        }

        function onPreviewMapReady(data) {
            totalFinalDuration = data.total_duration;
            document.getElementById('v-progress-bar').max = totalFinalDuration;
            if(currentFragment.start === -1) {
                virtualPlayerState.currentTime = 0;
                updateTimeDisplay();
                requestPreviewFragment(0);
            }
            document.getElementById('virtual-player').style.display = 'block';
        }

        function gatherCurrentParams() { lastProcessingParams = { use_ram: document.getElementById('use_ram').checked, mode: document.querySelector('input[name="mode"]:checked').value, is_single_segment: document.getElementById('is_single_segment').checked, intro_resolution: document.querySelector('input[name="intro_resolution"]:checked').value, start1: document.getElementById('start1').value, end1: document.getElementById('end1').value, start2: document.getElementById('start2').value, end2: document.getElementById('end2').value, output_dir: filePaths.output_dir, ...filePaths }; return lastProcessingParams; }
        function requestPreviewMap() { if (ws && ws.readyState === WebSocket.OPEN && filePaths.video1) { logOutput.textContent += '\n–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞—Ä—Ç—É –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞...\n'; gatherCurrentParams(); ws.send(JSON.stringify({ action: 'generate_preview_map', params: lastProcessingParams })); } }
        function submitForm() { if (!ws || ws.readyState !== WebSocket.OPEN || !filePaths.video1) return; document.getElementById('submitBtn').disabled = true; document.getElementById('submitBtn').textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...'; logOutput.textContent = '–ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å–±–æ—Ä–∫—É...\n'; ws.send(JSON.stringify({ action: 'process', params: gatherCurrentParams() })); }
        function sendMessage(action, path, id) { ws.send(JSON.stringify({ action, path, id })); }
        
        function connect() { 
            ws = new WebSocket(`ws://127.0.0.1:${SERVER_PORT}`); 
            ws.onopen = () => { logOutput.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.\n'; setTimeout(requestPreviewMap, 500); }; 
            ws.onclose = () => { setTimeout(connect, 2000); }; 
            ws.onmessage = (event) => { 
                const data = JSON.parse(event.data); 
                switch(data.action) { 
                    case 'log': 
                        if (data.message.startsWith('frame=')) { 
                             const lines = logOutput.textContent.split('\n');
                             if (lines.length > 1 && lines[lines.length - 2].startsWith('frame=')) { lines[lines.length - 2] = data.message; logOutput.textContent = lines.join('\n'); }
                             else { logOutput.textContent += data.message + '\n'; }
                        } else { logOutput.textContent += data.message + '\n'; } 
                        logOutput.scrollTop = logOutput.scrollHeight; 
                        break; 
                    case 'finished': document.getElementById('submitBtn').disabled = false; document.getElementById('submitBtn').textContent = '–ù–∞—á–∞—Ç—å –û–±—Ä–∞–±–æ—Ç–∫—É'; break; 
                    case 'browse_result': renderBrowser(data); break; 
                    case 'path_resolved': 
                        if (data.full_path) { 
                            filePaths[currentId] = data.full_path; 
                            document.getElementById(currentId + '_path').textContent = data.full_path; 
                            if (currentId === 'video1' || currentId === 'video2') requestPreviewMap(); 
                        } 
                        document.getElementById('file-modal').classList.add('hidden'); 
                        document.getElementById('select-dir-btn').classList.add('hidden'); 
                        saveState(); 
                        break; 
                    case 'error': 
                        logOutput.textContent += `\n–û–®–ò–ë–ö–ê: ${data.message}\n`; 
                        showLoading(false);
                        virtualPlayerState.isWaitingForFragment = false; // –°–±—Ä–æ—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                        break; 
                    case 'preview_map_ready': onPreviewMapReady(data); break; 
                    case 'preview_fragment_ready': onPreviewFragmentReady(data); break; 
                } 
            }; 
        }
        
        function renderBrowser(data) { const fileList = document.getElementById('file-list'); document.getElementById('current-path').value = data.path; fileList.innerHTML = ''; let html = ''; if (data.path !== '/') { const parentPath = data.path.substring(0, data.path.lastIndexOf('/')) || '/'; html += `<div class="file-entry dir" data-path="${parentPath}">.. (–ù–∞–≤–µ—Ä—Ö)</div>`; } html += (data.entries || []).map(e => `<div class="file-entry ${e.type}" data-path="${(data.path === '/' ? '' : data.path) + '/' + e.name}">${e.name}</div>`).join(''); fileList.innerHTML = html || '(–ø—É—Å—Ç–æ)'; }
        function goUp() { const p = document.getElementById('current-path').value; if (p !== '/') sendMessage('browse_path', p.substring(0, p.lastIndexOf('/')) || '/', currentId); }
        function openModal(id) { currentId = id; document.getElementById('file-modal').classList.remove('hidden'); document.getElementById('file-list').innerHTML = '(–∑–∞–≥—Ä—É–∑–∫–∞...)'; sendMessage('browse_path', '/', currentId); }
        function selectFile(id) { if (!ws || ws.readyState !== WebSocket.OPEN) return; document.getElementById('select-dir-btn').classList.add('hidden'); openModal(id); }
        function selectDirectory(id) { document.getElementById('select-dir-btn').classList.remove('hidden'); openModal(id); }
        function toggleMode() { const isSingleFile = document.getElementById('singleFile').checked; const isSingleSeg = document.getElementById('is_single_segment').checked; document.getElementById('video2_container').style.display = isSingleFile ? 'none' : 'block'; document.getElementById('audio2_container').style.display = isSingleFile ? 'none' : 'block'; document.getElementById('single_segment_toggle_div').style.display = isSingleFile ? 'block' : 'none'; document.getElementById('part2_timecodes').style.display = !isSingleFile || (isSingleFile && !isSingleSeg) ? 'block' : 'none'; saveState(); requestPreviewMap(); }
        function saveState() { const state = { filePaths, start1: document.getElementById('start1').value, end1: document.getElementById('end1').value, start2: document.getElementById('start2').value, end2: document.getElementById('end2').value, mode: document.querySelector('input[name="mode"]:checked').value, is_single_segment: document.getElementById('is_single_segment').checked, use_ram: document.getElementById('use_ram').checked, intro_resolution: document.querySelector('input[name="intro_resolution"]:checked').value }; localStorage.setItem('videoEditorState', JSON.stringify(state)); }
        function loadState() { const saved = localStorage.getItem('videoEditorState'); if (saved) { const state = JSON.parse(saved); filePaths = { ...filePaths, ...state.filePaths }; document.getElementById('start1').value = state.start1 || ''; document.getElementById('end1').value = state.end1 || ''; document.getElementById('start2').value = state.start2 || ''; document.getElementById('end2').value = state.end2 || ''; document.querySelector(`input[name="mode"][value="${state.mode || 'single'}"]`).checked = true; document.getElementById('is_single_segment').checked = state.is_single_segment || false; document.getElementById('use_ram').checked = state.use_ram !== false; document.querySelector(`input[name="intro_resolution"][value="${state.intro_resolution || '2k'}"]`).checked = true; Object.keys(filePaths).forEach(key => { if (filePaths[key] && !key.endsWith('_relative')) document.getElementById(key + '_path').textContent = filePaths[key]; }); } }

        function handleSeek(time) {
            virtualPlayerState.isSeeking = false;
            virtualPlayerState.isWaitingForFragment = true;
            virtualPlayerState.currentTime = time;
            document.getElementById('v-progress-bar').value = time; 
            
            activePlayer.pause();
            hiddenPlayer.pause();
            lastRequestedTime = -1;
            lastPreloadTime = -1;
            
            requestPreviewFragment(virtualPlayerState.currentTime);
        }

        window.onload = () => {
            loadState(); connect(); toggleMode();
            activePlayer = document.getElementById('videoPlayerA'); hiddenPlayer = document.getElementById('videoPlayerB');
            const vPlayBtn = document.getElementById('v-play-btn'); const vProgressBar = document.getElementById('v-progress-bar');
            
            [activePlayer, hiddenPlayer].forEach(p => {
                // –£–¥–∞–ª–∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ loadedmetadata —Å —Ä—É—á–Ω—ã–º —Ä–∞—Å—á–µ—Ç–æ–º –≤—ã—Å–æ—Ç—ã
                
                p.addEventListener('timeupdate', () => {
                    if (p !== activePlayer || virtualPlayerState.isSeeking || virtualPlayerState.isWaitingForFragment) return;
                    virtualPlayerState.currentTime = currentFragment.start + p.currentTime;
                    document.getElementById('v-time-display').textContent = `${secondsToHMS(virtualPlayerState.currentTime)} / ${secondsToHMS(totalFinalDuration)}`;
                    vProgressBar.value = virtualPlayerState.currentTime;
                    if (p.duration > 0 && p.duration - p.currentTime < PRELOAD_SECONDS) {
                        const nextStart = currentFragment.start + FRAGMENT_DURATION;
                        if (nextStart < totalFinalDuration) { requestPreviewFragment(nextStart, true); }
                    }
                });

                p.addEventListener('ended', () => {
                    if (p !== activePlayer || !virtualPlayerState.isPlaying) return;
                    const nextFragmentStart = currentFragment.start + FRAGMENT_DURATION;
                    if (nextFragmentStart >= totalFinalDuration) { virtualPlayerState.isPlaying = false; vPlayBtn.textContent = '‚ñ∂'; return; }
                    
                    if (hiddenPlayer.readyState >= 3 && hiddenPlayer.src) { 
                        currentFragment.start = nextFragmentStart; 
                        currentFragment.duration = hiddenPlayer.duration; 
                        swapPlayers(); 
                        activePlayer.play().catch(console.error);
                    } else {
                        showLoading(true);
                        hiddenPlayer.oncanplay = () => { 
                            showLoading(false);
                            currentFragment.start = nextFragmentStart; 
                            currentFragment.duration = hiddenPlayer.duration; 
                            swapPlayers(); 
                            activePlayer.play().catch(console.error);
                            hiddenPlayer.oncanplay = null; 
                        };
                    }
                });
            });

            vPlayBtn.addEventListener('click', () => { 
                virtualPlayerState.isPlaying = !virtualPlayerState.isPlaying; 
                vPlayBtn.textContent = virtualPlayerState.isPlaying ? '‚è∏' : '‚ñ∂'; 
                if (virtualPlayerState.isPlaying) { 
                    if (activePlayer.src) activePlayer.play().catch(console.error); 
                    else requestPreviewFragment(virtualPlayerState.currentTime); 
                } else { activePlayer.pause(); } 
            });
            
            vProgressBar.addEventListener('input', (e) => {
                virtualPlayerState.isSeeking = true;
                const val = parseFloat(e.target.value);
                document.getElementById('v-time-display').textContent = `${secondsToHMS(val)} / ${secondsToHMS(totalFinalDuration)}`;
            });
            
            vProgressBar.addEventListener('change', (e) => {
                handleSeek(parseFloat(e.target.value));
            });

            ['start1', 'end1', 'start2', 'end2'].forEach(id => { document.getElementById(id).addEventListener('change', () => { saveState(); requestPreviewMap(); }); });
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => input.addEventListener('change', () => { saveState(); if (input.name === 'mode' || input.name === 'is_single_segment' || input.name === 'intro_resolution') { requestPreviewMap(); } }));
            document.getElementById('close-btn').onclick = () => document.getElementById('file-modal').classList.add('hidden');
            document.getElementById('up-btn').onclick = goUp;
            document.getElementById('select-dir-btn').onclick = () => { sendMessage('resolve_path', document.getElementById('current-path').value, currentId); };
            document.getElementById('current-path').onkeydown = (e) => { if (e.key === 'Enter') sendMessage('browse_path', e.target.value, currentId); };
            document.getElementById('file-list').onclick = (e) => { const t = e.target.closest('.file-entry'); if (t) { if (t.classList.contains('dir')) sendMessage('browse_path', t.dataset.path, currentId); else if (!document.getElementById('select-dir-btn').classList.contains('hidden')) return; else sendMessage('resolve_path', t.dataset.path, currentId); } };
        };
    </script>
</body>
</html>