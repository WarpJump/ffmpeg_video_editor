<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–í–∏–¥–µ–æ –†–µ–¥–∞–∫—Ç–æ—Ä v21 (–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π)</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <style>
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #282a36; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; border: 1px solid #6272a4; }
        #file-list { height: 350px; overflow-y: auto; background: #21222c; padding: 5px; margin-bottom: 10px; border: 1px solid #44475a; }
        .file-entry { cursor: pointer; padding: 5px 8px; border-radius: 3px; }
        .file-entry:hover { background: #44475a; }
        .file-entry.dir::before { content: 'üìÅ '; } .file-entry.file::before { content: 'üìÑ '; }
        .hidden { display: none; }
        #path-container { display: flex; align-items: center; margin-bottom: 10px; }
        #current-path { flex-grow: 1; padding: 5px; background: #21222c; color: #f8f8f2; border: 1px solid #44475a; }
        #up-btn { background: #6272a4; color: #f8f8f2; border: none; padding: 5px 10px; margin-left: 5px; cursor: pointer; }
        #up-btn:hover { background: #bd93f9; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
    </style>
</head>
<body>
    <h1>–í–∏–¥–µ–æ –†–µ–¥–∞–∫—Ç–æ—Ä v21 (–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π)</h1>
     <div class="container">
        <div class="form-column">
             <fieldset><legend>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏</legend>
                <label>–†–µ–∂–∏–º –†–∞–±–æ—Ç—ã:</label>
                <div>
                    <input type="radio" id="singleFile" name="mode" value="single" checked onchange="toggleMode()">
                    <label for="singleFile" title="–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–≤–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –∏–∑ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ —Ñ–∞–π–ª–∞.">–û–¥–∏–Ω —Ñ–∞–π–ª</label>
                    <input type="radio" id="twoFiles" name="mode" value="two" onchange="toggleMode()">
                    <label for="twoFiles" title="–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–≤–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –∏–∑ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤.">–î–≤–∞ —Ñ–∞–π–ª–∞</label>
                </div>
                <div id="single_segment_toggle_div" style="margin-top:10px;">
                    <input type="checkbox" id="is_single_segment" name="is_single_segment" onchange="toggleMode()">
                    <label for="is_single_segment" title="–í—ã—Ä–µ–∑–∞—Ç—å –æ–¥–∏–Ω –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –∫—É—Å–æ–∫ –∏–∑ –≤–∏–¥–µ–æ, –¥–æ–±–∞–≤–∏–≤ –∏–Ω—Ç—Ä–æ –∏ –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ.">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –µ–¥–∏–Ω—ã–π —Ä–æ–ª–∏–∫</label>
                </div>
                <div style="margin-top:15px;">
                    <input type="checkbox" id="use_ram" checked>
                    <label for="use_ram" title="–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –≤ /dev/shm (–û–ó–£). –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ Linux. –£—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å, –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –û–ó–£.">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RAM-–¥–∏—Å–∫</label>
                </div>
                <div style="margin-top:15px;">
                    <label>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏–Ω—Ç—Ä–æ:</label>
                    <div>
                      <input type="radio" id="intro_fullhd" name="intro_resolution" value="fullhd"> <label for="intro_fullhd">FullHD (1080p)</label>
                      <input type="radio" id="intro_2k" name="intro_resolution" value="2k" checked> <label for="intro_2k">2K (1440p)</label>
                    </div>
                </div>
                <div style="margin-top:15px;">
                    <label>–í—ã—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è (–æ–ø—Ü–∏—è):</label>
                    <button type="button" onclick="selectDirectory('output_dir')">–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É...</button>
                    <div id="output_dir_path" class="file-path-display">(–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø–∞–ø–∫–∞ —Å "–í–∏–¥–µ–æ 1")</div>
                </div>
            </fieldset>
            <fieldset><legend>2. –§–∞–π–ª—ã</legend>
                <button type="button" onclick="selectFile('intro_file')">1. –í—ã–±—Ä–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫ –∏–Ω—Ç—Ä–æ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)</button><div id="intro_file_path" class="file-path-display"></div>
                <button type="button" onclick="selectFile('video1')">2. –í—ã–±—Ä–∞—Ç—å –í–∏–¥–µ–æ 1</button><div id="video1_path" class="file-path-display"></div>
                <div id="video2_container" class="hidden"><button type="button" onclick="selectFile('video2')">3. –í—ã–±—Ä–∞—Ç—å –í–∏–¥–µ–æ 2</button><div id="video2_path" class="file-path-display"></div></div>
                <button type="button" onclick="selectFile('audio1')">–ê—É–¥–∏–æ 1 (–æ–ø—Ü–∏—è)...</button><div id="audio1_path" class="file-path-display"></div>
                <div id="audio2_container" class="hidden"><button type="button" onclick="selectFile('audio2')">–ê—É–¥–∏–æ 2 (–æ–ø—Ü–∏—è)...</button><div id="audio2_path" class="file-path-display"></div></div>
            </fieldset>
             <fieldset><legend>3. –¢–∞–π–º–∫–æ–¥—ã</legend>
                <h4>–°–µ–≥–º–µ–Ω—Ç 1</h4>
                <div class="time-input-group"><label for="start1" style="width:60px;">–ù–∞—á–∞–ª–æ:</label> <input type="text" id="start1" placeholder="00:01:10"><button class="jump-btn" onclick="jumpToTime('start1')">‚ñ∂</button></div>
                <div class="time-input-group"><label for="end1" style="width:60px;">–ö–æ–Ω–µ—Ü:</label> <input type="text" id="end1" placeholder="00:45:30"><button class="jump-btn" onclick="jumpToTime('end1')">‚ñ∂</button></div>
                <div id="part2_timecodes"><hr style="border-color: var(--panel-bg);"><h4>–°–µ–≥–º–µ–Ω—Ç 2</h4>
                    <div class="time-input-group"><label for="start2" style="width:60px;">–ù–∞—á–∞–ª–æ:</label> <input type="text" id="start2" placeholder="00:00:15"><button class="jump-btn" onclick="jumpToTime('start2')">‚ñ∂</button></div>
                    <div class="time-input-group"><label for="end2" style="width:60px;">–ö–æ–Ω–µ—Ü:</label> <input type="text" id="end2" placeholder="00:30:00"><button class="jump-btn" onclick="jumpToTime('end2')">‚ñ∂</button></div>
                </div>
            </fieldset>
                <div style="display: flex; gap: 10px;">
                <button type="button" id="previewBtn" class="action-btn" onclick="generatePreview()" style="background-color: var(--accent-purple);">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
                <button type="button" id="submitBtn" class="action-btn" onclick="submitForm()">–ù–∞—á–∞—Ç—å –û–±—Ä–∞–±–æ—Ç–∫—É</button>
            </div>
        </div>
        <div class="preview-column">
            <h2>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
            <div id="v-player-container" class="virtual-player-container">
                <div class="virtual-player-controls">
                    <button id="v-play-btn">‚ñ∂</button>
                    <input type="range" id="v-progress-bar" value="0" step="0.1">
                    <div id="v-time-display">00:00:00 / 00:00:00</div>
                </div>
            </div>
            <video id="videoPreview"></video>
            <h2>–õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h2>
            <pre id="log-output">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É...</pre>
        </div>
    </div>
    <div id="file-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3>–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞</h3>
            <div id="path-container">
                <input id="current-path" type="text" value="/">
                <button id="up-btn" title="–í–≤–µ—Ä—Ö">‚Üë</button>
            </div>
            <div id="file-list">(–ø—É—Å—Ç–æ)</div>
            <div class="modal-buttons">
                <button id="select-dir-btn" class="hidden">–í—ã–±—Ä–∞—Ç—å —Ç–µ–∫—É—â—É—é –ø–∞–ø–∫—É</button>
                <button id="close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
    <script>
        const SERVER_PORT = "%%SERVER_PORT%%";
        const logOutput = document.getElementById('log-output');
        let filePaths = { video1: '', video2: '', audio1: '', audio2: '', intro_file: '', output_dir: '' };
        let ws;
        let currentId = '';

        let timelineMap = null;
        let totalDuration = 0;
        let virtualPlayerState = {
            isPlaying: false,
            currentSegmentIndex: 0,
            animationFrameId: null,
            isSeeking: false 
        };

        function hmsToSeconds(str) {
            if (!str) return 0; const p = str.split(':').map(Number); let s = 0;
            if (p.length === 3) s = p[0] * 3600 + p[1] * 60 + p[2];
            else if (p.length === 2) s = p[0] * 60 + p[1];
            else if (p.length === 1 && str) s = parseFloat(str);
            return isNaN(s) ? 0 : s;
        }
        function secondsToHMS(secs) {
            const h = Math.floor(secs / 3600).toString().padStart(2, '0');
            const m = Math.floor((secs % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(secs % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }
        function getCurrentParams() {
            return {
                use_ram: document.getElementById('use_ram').checked,
                mode: document.querySelector('input[name="mode"]:checked').value,
                is_single_segment: document.getElementById('is_single_segment').checked,
                intro_resolution: document.querySelector('input[name="intro_resolution"]:checked').value,
                start1: document.getElementById('start1').value, end1: document.getElementById('end1').value,
                start2: document.getElementById('start2').value, end2: document.getElementById('end2').value,
                ...filePaths
            };
        }

        function saveState() {
            const state = {
                filePaths: filePaths,
                start1: document.getElementById('start1').value,
                end1: document.getElementById('end1').value,
                start2: document.getElementById('start2').value,
                end2: document.getElementById('end2').value,
                mode: document.querySelector('input[name="mode"]:checked')?.value,
                is_single_segment: document.getElementById('is_single_segment').checked,
                use_ram: document.getElementById('use_ram').checked,
                intro_resolution: document.querySelector('input[name="intro_resolution"]:checked')?.value
            };
            localStorage.setItem('videoEditorState', JSON.stringify(state));
        }
        
        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω–∞—è, –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ ---
        function loadState() {
            try {
                const savedStateJSON = localStorage.getItem('videoEditorState');
                if (!savedStateJSON) return;

                const state = JSON.parse(savedStateJSON);

                if (state.filePaths) {
                    filePaths = state.filePaths;
                    for (const id in filePaths) {
                        if (filePaths[id] && document.getElementById(id + '_path')) {
                           document.getElementById(id + '_path').textContent = filePaths[id];
                        }
                    }
                }

                document.getElementById('start1').value = state.start1 || '';
                document.getElementById('end1').value = state.end1 || '';
                document.getElementById('start2').value = state.start2 || '';
                document.getElementById('end2').value = state.end2 || '';

                if (state.mode) {
                    const modeEl = document.querySelector(`input[name="mode"][value="${state.mode}"]`);
                    if (modeEl) modeEl.checked = true;
                }
                if (state.intro_resolution) {
                    const resEl = document.querySelector(`input[name="intro_resolution"][value="${state.intro_resolution}"]`);
                    if (resEl) resEl.checked = true;
                }
                
                // –î–ª—è checkbox-–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ undefined
                if(typeof state.is_single_segment !== 'undefined') document.getElementById('is_single_segment').checked = state.is_single_segment;
                if(typeof state.use_ram !== 'undefined') document.getElementById('use_ram').checked = state.use_ram;

            } catch (e) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:", e);
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã, –æ—á–∏—â–∞–µ–º –∏—Ö, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É —Å–Ω–æ–≤–∞
                localStorage.removeItem('videoEditorState');
            }
        }
        


        function jumpToTime(id) {
            const time = hmsToSeconds(document.getElementById(id).value);
            const video = document.getElementById('videoPreview');
            if (!isNaN(time) && video.duration) {
                video.currentTime = time;
                video.play();
            }
        }

        function generatePreview() {
            if (!ws || ws.readyState !== WebSocket.OPEN) { logOutput.textContent += '\n–û—à–∏–±–∫–∞: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.\n'; return; }
            if (!filePaths.video1) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –í–∏–¥–µ–æ 1"); return; }
            
            logOutput.textContent = '–ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞...\n';
            ws.send(JSON.stringify({ action: 'generate_preview_map', params: getCurrentParams() }));
        }
        
        function initializeVirtualPlayer(data) {
            timelineMap = data.timeline_map;
            totalDuration = data.total_duration;

            document.getElementById('v-player-container').style.display = 'block';
            document.getElementById('v-progress-bar').max = totalDuration;
            updateVirtualTimeDisplay(0);

            const videoEl = document.getElementById('videoPreview');
            videoEl.style.display = 'block';
            videoEl.controls = false;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä –ø–µ—Ä–≤–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞
            switchToSegment(0, 0, false); 
        }

        function updateVirtualTimeDisplay(currentTime) {
            document.getElementById('v-time-display').textContent = `${secondsToHMS(currentTime)} / ${secondsToHMS(totalDuration)}`;
            if (!virtualPlayerState.isSeeking) {
                document.getElementById('v-progress-bar').value = currentTime;
            }
        }

        function handleVirtualPlayPause() {
            virtualPlayerState.isPlaying = !virtualPlayerState.isPlaying;
            const videoEl = document.getElementById('videoPreview');
            const playBtn = document.getElementById('v-play-btn');

            if (virtualPlayerState.isPlaying) {
                playBtn.textContent = '‚ùö‚ùö';
                videoEl.play().catch(e => console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:", e));
            } else {
                playBtn.textContent = '‚ñ∂';
                videoEl.pause();
            }
        }
        
        function handleVirtualSeek(event) {
            const seekTime = parseFloat(event.target.value);
            const { segmentIndex, timeInSegment } = findSegmentForTime(seekTime);
            
            if (segmentIndex !== -1) {
                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 3: –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–µ–≥–º–µ–Ω—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
                switchToSegment(segmentIndex, timeInSegment, virtualPlayerState.isPlaying);
            }
        }

        function findSegmentForTime(time) {
            for (let i = 0; i < timelineMap.length; i++) {
                const segment = timelineMap[i];
                if (time >= segment.timeline_start && time < segment.timeline_start + segment.duration) {
                    return { segmentIndex: i, timeInSegment: time - segment.timeline_start };
                }
            }
            // –ï—Å–ª–∏ –≤—Ä–µ–º—è —Ä–∞–≤–Ω–æ –∏–ª–∏ –±–æ–ª—å—à–µ –∫–æ–Ω—Ü–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω–µ—Ü –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
            const lastIdx = timelineMap.length - 1;
            const lastSegment = timelineMap[lastIdx];
            return { segmentIndex: lastIdx, timeInSegment: lastSegment.duration };
        }

        function switchToSegment(segmentIndex, startTimeInSegment = 0, shouldPlay = false) {
            cancelAnimationFrame(virtualPlayerState.animationFrameId); // –í—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ü–∏–∫–ª
            virtualPlayerState.currentSegmentIndex = segmentIndex;
            const segment = timelineMap[segmentIndex];

            if (!segment) {
                if (virtualPlayerState.isPlaying) handleVirtualPlayPause();
                updateVirtualTimeDisplay(totalDuration);
                return;
            }

            const videoEl = document.getElementById('videoPreview');
            const sourceStartTime = segment.source_start_time + startTimeInSegment;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º src —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–∏—à–Ω–∏—Ö –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫
            const newSrc = `/video?path=${encodeURIComponent(segment.source_file)}#t=${sourceStartTime}`;
            if (videoEl.src.endsWith(newSrc) && shouldPlay) {
                 videoEl.play().catch(e => console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:", e));
            } else {
                 videoEl.src = newSrc;
            }
            
            if (shouldPlay) {
                // –ú—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ –≤—ã–∑–≤–∞—Ç—å play() –∑–¥–µ—Å—å, —Ç.–∫. —Ñ–∞–π–ª –º–æ–∂–µ—Ç –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è.
                // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –º—ã –¥–æ–≤–µ—Ä—è–µ–º —Å–æ–±—ã—Ç–∏—é `canplay` –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.
                virtualPlayerState.isPlaying = true;
                document.getElementById('v-play-btn').textContent = '‚ùö‚ùö';
            }
        }
        
        function onVideoTimeUpdate() {
            const videoEl = document.getElementById('videoPreview');
            const currentSegment = timelineMap[virtualPlayerState.currentSegmentIndex];
            if (!currentSegment || videoEl.paused || virtualPlayerState.isSeeking) return;

            const currentTimeInSegment = videoEl.currentTime - currentSegment.source_start_time;
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Å–µ–≥–º–µ–Ω—Ç —Å –Ω–µ–±–æ–ª—å—à–∏–º –∑–∞–ø–∞—Å–æ–º
            if (currentTimeInSegment >= currentSegment.duration - 0.1) {
                switchToSegment(virtualPlayerState.currentSegmentIndex + 1, 0, true);
            } else {
                 const virtualCurrentTime = currentSegment.timeline_start + currentTimeInSegment;
                 updateVirtualTimeDisplay(virtualCurrentTime);
            }
        }

        function updateLoop() {
            if (!virtualPlayerState.isPlaying || virtualPlayerState.isSeeking) {
                cancelAnimationFrame(virtualPlayerState.animationFrameId);
                return;
            }

            const videoEl = document.getElementById('videoPreview');
            const currentSegment = timelineMap[virtualPlayerState.currentSegmentIndex];
            
            if (!videoEl.paused) {
                 const currentTimeInSegment = videoEl.currentTime - currentSegment.source_start_time;
                 const virtualCurrentTime = currentSegment.timeline_start + currentTimeInSegment;

                 updateVirtualTimeDisplay(virtualCurrentTime);
            
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è –ª–∏ —Å–µ–≥–º–µ–Ω—Ç
                if (currentTimeInSegment >= currentSegment.duration) {
                    switchToSegment(virtualPlayerState.currentSegmentIndex + 1, 0, true);
                }
            }
            
            virtualPlayerState.animationFrameId = requestAnimationFrame(updateLoop);
        }
        

        function getCurrentParams() {
            return {
                use_ram: document.getElementById('use_ram').checked,
                mode: document.querySelector('input[name="mode"]:checked').value,
                is_single_segment: document.getElementById('is_single_segment').checked,
                intro_resolution: document.querySelector('input[name="intro_resolution"]:checked').value,
                start1: document.getElementById('start1').value, end1: document.getElementById('end1').value,
                start2: document.getElementById('start2').value, end2: document.getElementById('end2').value,
                ...filePaths
            };
        }

        function connect() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${wsProtocol}//${window.location.hostname}:${SERVER_PORT}`); 
            ws.onopen = () => { /*...*/ };
            ws.onerror = () => { /*...*/ };
            ws.onclose = () => { /*...*/ };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                switch (data.action) {
                    case 'preview_map_ready': initializeVirtualPlayer(data); break;
                    
                    // --- –ò–ó–ú–ï–ù–ï–ù–ù–´–ô –ë–õ–û–ö ---
                    case 'path_resolved':
                        if (data.full_path) {
                            filePaths[currentId] = data.full_path;
                            document.getElementById(currentId + '_path').textContent = data.full_path;
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–æ–π —Ä–µ–∂–∏–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                            if ((currentId === 'video1' || currentId === 'video2')) {
                                if (data.preview_mode === 'http') {
                                    // –°–µ—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º: –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à —Å–µ—Ä–≤–µ—Ä
                                    document.getElementById('videoPreview').src = `/video?path=${encodeURIComponent(data.relative_path)}`;
                                } else {
                                    // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º: –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª—É
                                    document.getElementById('videoPreview').src = `file://${data.full_path}`;
                                }
                            }
                            saveState();
                        }
                        document.getElementById('file-modal').classList.add('hidden');
                        break;
                    // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê ---

                    case 'log': /*...*/ break;
                    case 'finished': /*...*/ break;
                    case 'error': /*...*/ break;
                }
            };
        }
                
        function sendMessage(action, path) {
             if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ action, path }));
            } else {
                logOutput.textContent += '\n–û—à–∏–±–∫–∞: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.\n';
            }
        }

        function renderBrowser({ path, entries }) {
            const fileList = document.getElementById('file-list');
            document.getElementById('current-path').value = path;
            const html = entries.map(e => {
                const fullPath = (path === '/' ? '' : path) + '/' + e.name;
                return `<div class="file-entry ${e.type}" data-path="${fullPath}">${e.name}</div>`;
            }).join('');
            fileList.innerHTML = html || '(–ø—É—Å—Ç–æ)';
        }

        function openModal(id) {
            if (!ws || ws.readyState !== WebSocket.OPEN) { logOutput.textContent += '\n–û—à–∏–±–∫–∞: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.\n'; return; }
            currentId = id;
            document.getElementById('file-modal').classList.remove('hidden');
            sendMessage('browse_path', '/');
        }

        function selectFile(id) {
            document.getElementById('select-dir-btn').classList.add('hidden');
            openModal(id);
        }

        function selectDirectory(id) {
            document.getElementById('select-dir-btn').classList.remove('hidden');
            openModal(id);
        }
        
        function toggleMode() {
            const isSingleFileMode = document.getElementById('singleFile').checked;
            const isSingleSegmentMode = document.getElementById('is_single_segment').checked;
            
            document.getElementById('video2_container').style.display = isSingleFileMode ? 'none' : 'block';
            document.getElementById('audio2_container').style.display = isSingleFileMode ? 'none' : 'block';
            document.getElementById('single_segment_toggle_div').style.display = isSingleFileMode ? 'block' : 'none';
            
            const showSecondTimecodes = !isSingleFileMode || (isSingleFileMode && !isSingleSegmentMode);
            document.getElementById('part2_timecodes').style.display = showSecondTimecodes ? 'block' : 'none';

            saveState(); 
        }

        function submitForm() {
            if (!ws || ws.readyState !== WebSocket.OPEN) { logOutput.textContent += '\n–û—à–∏–±–∫–∞: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.\n'; return; }
            if (!filePaths.video1) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –í–∏–¥–µ–æ 1"); return; }
            
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            logOutput.textContent = '–ó–∞–ø—É—Å–∫–∞–µ–º...\n';
            
            const params = {
                use_ram: document.getElementById('use_ram').checked,
                mode: document.querySelector('input[name="mode"]:checked').value,
                is_single_segment: document.getElementById('is_single_segment').checked,
                intro_resolution: document.querySelector('input[name="intro_resolution"]:checked').value,
                start1: document.getElementById('start1').value, end1: document.getElementById('end1').value,
                start2: document.getElementById('start2').value, end2: document.getElementById('end2').value,
                ...filePaths
            };
            ws.send(JSON.stringify({ action: 'process', params: params }));
        }

        window.onload = () => {
            connect();
            loadState(); 
            toggleMode();

            document.querySelectorAll('input[type="text"]').forEach(input => {
                input.addEventListener('input', saveState); 
            });
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
                input.addEventListener('change', saveState);
            });

            document.getElementById('close-btn').onclick = () => document.getElementById('file-modal').classList.add('hidden');
            document.getElementById('up-btn').onclick = () => {
                 const currentPath = document.getElementById('current-path').value;
                 if (currentPath !== '/') {
                    const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/')) || '/';
                    sendMessage('browse_path', parentPath);
                 }
            };
            document.getElementById('select-dir-btn').onclick = () => {
                const path = document.getElementById('current-path').value;
                sendMessage('resolve_path', path);
            };
            document.getElementById('current-path').onkeydown = (e) => { if (e.key === 'Enter') sendMessage('browse_path', e.target.value); };
            
            document.getElementById('file-list').onclick = (e) => {
                const target = e.target.closest('.file-entry');
                if (!target) return;
                const path = target.dataset.path;
                const isDir = target.classList.contains('dir');
                if (isDir) {
                    sendMessage('browse_path', path);
                } else if (!document.getElementById('select-dir-btn').classList.contains('hidden')) {
                    return;
                } else {
                    sendMessage('resolve_path', path);
                }
            };

            document.getElementById('v-play-btn').onclick = handleVirtualPlayPause;
            document.getElementById('v-progress-bar').addEventListener('input', handleVirtualSeek);
            
            document.getElementById('videoPreview').addEventListener('playing', updateLoop);
             const videoEl = document.getElementById('videoPreview');
            const progressBar = document.getElementById('v-progress-bar');
            
            document.getElementById('v-play-btn').onclick = handleVirtualPlayPause;
            
            progressBar.addEventListener('mousedown', () => virtualPlayerState.isSeeking = true);
            progressBar.addEventListener('input', handleVirtualSeek);
            progressBar.addEventListener('mouseup', () => virtualPlayerState.isSeeking = false);

            videoEl.addEventListener('timeupdate', onVideoTimeUpdate);

            videoEl.addEventListener('canplay', () => {
                if (virtualPlayerState.isPlaying) {
                    videoEl.play().catch(e => console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ-–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:", e));
                }
            });
        };
    </script>
</body>
</html>