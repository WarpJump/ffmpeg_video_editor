<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–í–∏–¥–µ–æ –†–µ–¥–∞–∫—Ç–æ—Ä v21 (–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π)</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #282a36; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; border: 1px solid #6272a4; }
        #file-list { height: 350px; overflow-y: auto; background: #21222c; padding: 5px; margin-bottom: 10px; border: 1px solid #44475a; }
        .file-entry { cursor: pointer; padding: 5px 8px; border-radius: 3px; }
        .file-entry:hover { background: #44475a; }
        .file-entry.dir::before { content: 'üìÅ '; } .file-entry.file::before { content: 'üìÑ '; }
        .hidden { display: none; }
        #path-container { display: flex; align-items: center; margin-bottom: 10px; }
        #current-path { flex-grow: 1; padding: 5px; background: #21222c; color: #f8f8f2; border: 1px solid #44475a; }
        #up-btn { background: #6272a4; color: #f8f8f2; border: none; padding: 5px 10px; margin-left: 5px; cursor: pointer; }
        #up-btn:hover { background: #bd93f9; }
    </style>
</head>
<body>
    <h1>–í–∏–¥–µ–æ –†–µ–¥–∞–∫—Ç–æ—Ä v21 (–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π)</h1>
     <div class="container">
        <div class="form-column">
            <fieldset><legend>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏</legend>
                <label>–†–µ–∂–∏–º –†–∞–±–æ—Ç—ã:</label>
                <div>
                    <input type="radio" id="singleFile" name="mode" value="single" checked onchange="toggleMode()"> 
                    <label for="singleFile" title="–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–≤–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –∏–∑ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ —Ñ–∞–π–ª–∞.">–û–¥–∏–Ω —Ñ–∞–π–ª</label>
                    <input type="radio" id="twoFiles" name="mode" value="two" onchange="toggleMode()"> 
                    <label for="twoFiles" title="–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–≤–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –∏–∑ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤.">–î–≤–∞ —Ñ–∞–π–ª–∞</label>
                </div>
                <div id="single_segment_toggle_div" style="margin-top:10px;">
                    <input type="checkbox" id="is_single_segment" name="is_single_segment" onchange="toggleMode()"> 
                    <label for="is_single_segment" title="–í—ã—Ä–µ–∑–∞—Ç—å –æ–¥–∏–Ω –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –∫—É—Å–æ–∫ –∏–∑ –≤–∏–¥–µ–æ, –¥–æ–±–∞–≤–∏–≤ –∏–Ω—Ç—Ä–æ –∏ –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ.">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –µ–¥–∏–Ω—ã–π —Ä–æ–ª–∏–∫</label>
                </div>
                <div style="margin-top:15px;">
                    <input type="checkbox" id="use_ram" checked> 
                    <label for="use_ram" title="–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –≤ /dev/shm (–û–ó–£). –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ Linux. –£—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å, –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –û–ó–£.">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RAM-–¥–∏—Å–∫</label>
                </div>
                <div style="margin-top:15px;">
                    <label>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏–Ω—Ç—Ä–æ:</label>
                    <div>
                      <input type="radio" id="intro_fullhd" name="intro_resolution" value="fullhd"> <label for="intro_fullhd">FullHD (1080p)</label>
                      <input type="radio" id="intro_2k" name="intro_resolution" value="2k" checked> <label for="intro_2k">2K (1440p)</label>
                    </div>
                </div>
            </fieldset>
            <fieldset><legend>2. –§–∞–π–ª—ã</legend>
                <button type="button" onclick="selectFile('intro_file')">1. –í—ã–±—Ä–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫ –∏–Ω—Ç—Ä–æ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)</button><div id="intro_file_path" class="file-path-display"></div>
                <button type="button" onclick="selectFile('video1')">2. –í—ã–±—Ä–∞—Ç—å –í–∏–¥–µ–æ 1</button><div id="video1_path" class="file-path-display"></div>
                <div id="video2_container" class="hidden"><button type="button" onclick="selectFile('video2')">3. –í—ã–±—Ä–∞—Ç—å –í–∏–¥–µ–æ 2</button><div id="video2_path" class="file-path-display"></div></div>
                <button type="button" onclick="selectFile('audio1')">–ê—É–¥–∏–æ 1 (–æ–ø—Ü–∏—è)...</button><div id="audio1_path" class="file-path-display"></div>
                <div id="audio2_container" class="hidden"><button type="button" onclick="selectFile('audio2')">–ê—É–¥–∏–æ 2 (–æ–ø—Ü–∏—è)...</button><div id="audio2_path" class="file-path-display"></div></div>
            </fieldset>
             <fieldset><legend>3. –¢–∞–π–º–∫–æ–¥—ã</legend>
                <h4>–°–µ–≥–º–µ–Ω—Ç 1</h4>
                <div class="time-input-group"><label for="start1" style="width:60px;">–ù–∞—á–∞–ª–æ:</label> <input type="text" id="start1" placeholder="00:01:10"><button class="jump-btn" onclick="jumpToTime('start1')">‚ñ∂</button></div>
                <div class="time-input-group"><label for="end1" style="width:60px;">–ö–æ–Ω–µ—Ü:</label> <input type="text" id="end1" placeholder="00:45:30"><button class="jump-btn" onclick="jumpToTime('end1')">‚ñ∂</button></div>
                <div id="part2_timecodes"><hr style="border-color: var(--panel-bg);"><h4>–°–µ–≥–º–µ–Ω—Ç 2</h4>
                    <div class="time-input-group"><label for="start2" style="width:60px;">–ù–∞—á–∞–ª–æ:</label> <input type="text" id="start2" placeholder="00:00:15"><button class="jump-btn" onclick="jumpToTime('start2')">‚ñ∂</button></div>
                    <div class="time-input-group"><label for="end2" style="width:60px;">–ö–æ–Ω–µ—Ü:</label> <input type="text" id="end2" placeholder="00:30:00"><button class="jump-btn" onclick="jumpToTime('end2')">‚ñ∂</button></div>
                </div>
            </fieldset>
            <button type="button" id="submitBtn" class="action-btn" onclick="submitForm()">–ù–∞—á–∞—Ç—å –û–±—Ä–∞–±–æ—Ç–∫—É</button>
        </div>
        <div class="preview-column"><h2>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2><video id="videoPreview" controls></video><h2>–õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h2><pre id="log-output">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É...</pre></div>
    </div>
    <div id="file-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3>–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞</h3>
            <div id="path-container">
                <input id="current-path" type="text" value="/">
                <button id="up-btn" title="–í–≤–µ—Ä—Ö">‚Üë</button>
            </div>
            <div id="file-list">(–ø—É—Å—Ç–æ)</div>
            <button id="close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    <script>
        const SERVER_PORT = "%%SERVER_PORT%%"; // –≠—Ç–æ—Ç –ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç Python —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        const logOutput = document.getElementById('log-output');
        let filePaths = { video1: '', video2: '', audio1: '', audio2: '', intro_file: '' };
        let ws;
        let currentId = '';

        function hmsToSeconds(str) {
            if (!str) return 0;
            const p = str.split(':').map(Number);
            let s = 0;
            if (p.length === 3) s = p[0] * 3600 + p[1] * 60 + p[2];
            else if (p.length === 2) s = p[0] * 60 + p[1];
            else if (p.length === 1 && str) s = parseFloat(str);
            return isNaN(s) ? 0 : s;
        }

        function jumpToTime(id) {
            const input = document.getElementById(id);
            const time = hmsToSeconds(input.value);
            const video = document.getElementById('videoPreview');
            if (!isNaN(time) && video.duration) {
                video.currentTime = time;
                video.play();
            }
        }

        function connect() {
            ws = new WebSocket(`ws://127.0.0.1:${SERVER_PORT}`);
            ws.onopen = () => { logOutput.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.\n'; };
            ws.onerror = () => { logOutput.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è WebSocket. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã...\n'; };
            ws.onclose = () => { setTimeout(connect, 2000); };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.action === 'browse_result') {
                    renderBrowser(data);
                } else if (data.action === 'path_resolved') {
                    if (data.full_path) {
                        filePaths[currentId] = data.full_path;
                        document.getElementById(currentId + '_path').textContent = data.full_path;
                        if (currentId === 'video1' || currentId === 'video2') {
                            document.getElementById('videoPreview').src = 'file://' + data.full_path;
                        }
                    }
                    document.getElementById('file-modal').classList.add('hidden');
                } else if (data.action === 'log') {
                    if (data.message.startsWith('frame=')) {
                        const lines = logOutput.textContent.split('\n');
                        if (lines.length > 1 && lines[lines.length - 2].startsWith('frame=')) {
                            lines[lines.length - 2] = data.message;
                            logOutput.textContent = lines.join('\n');
                        } else {
                            logOutput.textContent += data.message + '\n';
                        }
                    } else {
                        logOutput.textContent += data.message + '\n';
                    }
                    logOutput.scrollTop = logOutput.scrollHeight;
                } else if (data.action === 'finished') {
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').textContent = '–ù–∞—á–∞—Ç—å –û–±—Ä–∞–±–æ—Ç–∫—É';
                } else if (data.action === 'error') {
                    alert(data.message);
                }
            };
        }
        
        function sendMessage(action, path) {
            ws.send(JSON.stringify({ action, path }));
        }

        function renderBrowser({ path, entries }) {
            const fileList = document.getElementById('file-list');
            const pathInput = document.getElementById('current-path');
            pathInput.value = path;
            
            let html = '';
            // –ö–Ω–æ–ø–∫–∞ "–ù–∞–≤–µ—Ä—Ö" —É–∂–µ –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ, —Ç–∞–∫ —á—Ç–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º ".."
            html += entries.map(e => {
                const fullPath = (path === '/' ? '' : path) + '/' + e.name;
                return `<div class="file-entry ${e.type}" data-path="${fullPath}">${e.name}</div>`;
            }).join('');
            
            fileList.innerHTML = html || '(–ø—É—Å—Ç–æ)';
        }

        function goUp() {
            const pathInput = document.getElementById('current-path');
            let currentPath = pathInput.value;
            if (currentPath !== '/') {
                const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/')) || '/';
                sendMessage('browse_path', parentPath);
            }
        }

        function selectFile(id) {
            if (!ws || ws.readyState !== WebSocket.OPEN) { logOutput.textContent += '\n–û—à–∏–±–∫–∞: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.\n'; return; }
            currentId = id;
            document.getElementById('file-modal').classList.remove('hidden');
            sendMessage('browse_path', '/');
        }
        
        function toggleMode() {
            const isSingleFileMode = document.getElementById('singleFile').checked;
            const isSingleSegmentMode = document.getElementById('is_single_segment').checked;
            
            document.getElementById('video2_container').style.display = isSingleFileMode ? 'none' : 'block';
            document.getElementById('audio2_container').style.display = isSingleFileMode ? 'none' : 'block';
            document.getElementById('single_segment_toggle_div').style.display = isSingleFileMode ? 'block' : 'none';
            
            const showSecondTimecodes = !isSingleFileMode || (isSingleFileMode && !isSingleSegmentMode);
            document.getElementById('part2_timecodes').style.display = showSecondTimecodes ? 'block' : 'none';
        }

        function submitForm() {
            if (!ws || ws.readyState !== WebSocket.OPEN) { logOutput.textContent += '\n–û—à–∏–±–∫–∞: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.\n'; return; }
            if (!filePaths.video1) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –í–∏–¥–µ–æ 1"); return; }
            
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            logOutput.textContent = '–ó–∞–ø—É—Å–∫–∞–µ–º...\n';
            
            const params = {
                use_ram: document.getElementById('use_ram').checked,
                mode: document.querySelector('input[name="mode"]:checked').value,
                is_single_segment: document.getElementById('is_single_segment').checked,
                intro_resolution: document.querySelector('input[name="intro_resolution"]:checked').value,
                start1: document.getElementById('start1').value, end1: document.getElementById('end1').value,
                start2: document.getElementById('start2').value, end2: document.getElementById('end2').value,
                ...filePaths
            };
            ws.send(JSON.stringify({ action: 'process', params: params }));
        }

        window.onload = () => {
            connect();
            toggleMode();
            document.getElementById('close-btn').onclick = () => document.getElementById('file-modal').classList.add('hidden');
            document.getElementById('up-btn').onclick = goUp;
            document.getElementById('current-path').onkeydown = (e) => {
                if (e.key === 'Enter') {
                    sendMessage('browse_path', e.target.value);
                }
            };
            document.getElementById('file-list').onclick = (e) => {
                if (!e.target.classList.contains('file-entry')) return;
                const path = e.target.dataset.path;
                const isDir = e.target.classList.contains('dir');
                sendMessage(isDir ? 'browse_path' : 'resolve_path', path);
            };
        };
    </script>
</body>
</html>