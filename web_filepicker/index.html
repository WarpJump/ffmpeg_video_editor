<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–í–∏–¥–µ–æ –†–µ–¥–∞–∫—Ç–æ—Ä v21 (–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π)</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <style>
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #282a36; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; border: 1px solid #6272a4; }
        #file-list { height: 350px; overflow-y: auto; background: #21222c; padding: 5px; margin-bottom: 10px; border: 1px solid #44475a; }
        .file-entry { cursor: pointer; padding: 5px 8px; border-radius: 3px; }
        .file-entry:hover { background: #44475a; }
        .file-entry.dir::before { content: 'üìÅ '; } .file-entry.file::before { content: 'üìÑ '; }
        .hidden { display: none; }
        #path-container { display: flex; align-items: center; margin-bottom: 10px; }
        #current-path { flex-grow: 1; padding: 5px; background: #21222c; color: #f8f8f2; border: 1px solid #44475a; }
        #up-btn { background: #6272a4; color: #f8f8f2; border: none; padding: 5px 10px; margin-left: 5px; cursor: pointer; }
        #up-btn:hover { background: #bd93f9; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
        .virtual-player-container {
            background: var(--log-bg);
            padding: 10px;
            border: 1px solid var(--panel-bg);
            border-bottom: none;
            display: none; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç */
        }
        .virtual-player-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #v-play-btn {
            background: var(--accent-purple);
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            padding: 0;
            flex-shrink: 0;
            margin: 0;
        }
        #v-time-display {
            font-family: monospace;
            font-size: 1.1em;
            color: var(--accent-green);
            min-width: 180px;
        }
        #v-progress-bar {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: var(--panel-bg);
            outline: none;
            cursor: pointer;
        }
        #v-progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-green);
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>–í–∏–¥–µ–æ –†–µ–¥–∞–∫—Ç–æ—Ä v21 (–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π)</h1>
     <div class="container">
        <div class="form-column">
             <fieldset><legend>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏</legend>
                <label>–†–µ–∂–∏–º –†–∞–±–æ—Ç—ã:</label>
                <div>
                    <input type="radio" id="singleFile" name="mode" value="single" checked onchange="toggleMode()">
                    <label for="singleFile" title="–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–≤–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –∏–∑ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ —Ñ–∞–π–ª–∞.">–û–¥–∏–Ω —Ñ–∞–π–ª</label>
                    <input type="radio" id="twoFiles" name="mode" value="two" onchange="toggleMode()">
                    <label for="twoFiles" title="–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–≤–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –∏–∑ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤.">–î–≤–∞ —Ñ–∞–π–ª–∞</label>
                </div>
                <div id="single_segment_toggle_div" style="margin-top:10px;">
                    <input type="checkbox" id="is_single_segment" name="is_single_segment" onchange="toggleMode()">
                    <label for="is_single_segment" title="–í—ã—Ä–µ–∑–∞—Ç—å –æ–¥–∏–Ω –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –∫—É—Å–æ–∫ –∏–∑ –≤–∏–¥–µ–æ, –¥–æ–±–∞–≤–∏–≤ –∏–Ω—Ç—Ä–æ –∏ –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ.">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –µ–¥–∏–Ω—ã–π —Ä–æ–ª–∏–∫</label>
                </div>
                <div style="margin-top:15px;">
                    <input type="checkbox" id="use_ram" checked>
                    <label for="use_ram" title="–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –≤ /dev/shm (–û–ó–£). –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ Linux. –£—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å, –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –û–ó–£.">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RAM-–¥–∏—Å–∫</label>
                </div>
                <div style="margin-top:15px;">
                    <label>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏–Ω—Ç—Ä–æ:</label>
                    <div>
                      <input type="radio" id="intro_fullhd" name="intro_resolution" value="fullhd"> <label for="intro_fullhd">FullHD (1080p)</label>
                      <input type="radio" id="intro_2k" name="intro_resolution" value="2k" checked> <label for="intro_2k">2K (1440p)</label>
                    </div>
                </div>
                <div style="margin-top:15px;">
                    <label>–í—ã—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è (–æ–ø—Ü–∏—è):</label>
                    <button type="button" onclick="selectDirectory('output_dir')">–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É...</button>
                    <div id="output_dir_path" class="file-path-display">(–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø–∞–ø–∫–∞ —Å "–í–∏–¥–µ–æ 1")</div>
                </div>
            </fieldset>
            <fieldset><legend>2. –§–∞–π–ª—ã</legend>
                <button type="button" onclick="selectFile('intro_file')">1. –í—ã–±—Ä–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫ –∏–Ω—Ç—Ä–æ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)</button><div id="intro_file_path" class="file-path-display"></div>
                <button type="button" onclick="selectFile('video1')">2. –í—ã–±—Ä–∞—Ç—å –í–∏–¥–µ–æ 1</button><div id="video1_path" class="file-path-display"></div>
                <div id="video2_container" class="hidden"><button type="button" onclick="selectFile('video2')">3. –í—ã–±—Ä–∞—Ç—å –í–∏–¥–µ–æ 2</button><div id="video2_path" class="file-path-display"></div></div>
                <button type="button" onclick="selectFile('audio1')">–ê—É–¥–∏–æ 1 (–æ–ø—Ü–∏—è)...</button><div id="audio1_path" class="file-path-display"></div>
                <div id="audio2_container" class="hidden"><button type="button" onclick="selectFile('audio2')">–ê—É–¥–∏–æ 2 (–æ–ø—Ü–∏—è)...</button><div id="audio2_path" class="file-path-display"></div></div>
            </fieldset>
             <fieldset><legend>3. –¢–∞–π–º–∫–æ–¥—ã</legend>
                <h4>–°–µ–≥–º–µ–Ω—Ç 1</h4>
                <div class="time-input-group"><label for="start1" style="width:60px;">–ù–∞—á–∞–ª–æ:</label> <input type="text" id="start1" placeholder="00:01:10"><button class="jump-btn" onclick="jumpToTime('start1')">‚ñ∂</button></div>
                <div class="time-input-group"><label for="end1" style="width:60px;">–ö–æ–Ω–µ—Ü:</label> <input type="text" id="end1" placeholder="00:45:30"><button class="jump-btn" onclick="jumpToTime('end1')">‚ñ∂</button></div>
                <div id="part2_timecodes"><hr style="border-color: var(--panel-bg);"><h4>–°–µ–≥–º–µ–Ω—Ç 2</h4>
                    <div class="time-input-group"><label for="start2" style="width:60px;">–ù–∞—á–∞–ª–æ:</label> <input type="text" id="start2" placeholder="00:00:15"><button class="jump-btn" onclick="jumpToTime('start2')">‚ñ∂</button></div>
                    <div class="time-input-group"><label for="end2" style="width:60px;">–ö–æ–Ω–µ—Ü:</label> <input type="text" id="end2" placeholder="00:30:00"><button class="jump-btn" onclick="jumpToTime('end2')">‚ñ∂</button></div>
                </div>
            </fieldset>
            <button type="button" id="submitBtn" class="action-btn" onclick="submitForm()">–ù–∞—á–∞—Ç—å –û–±—Ä–∞–±–æ—Ç–∫—É</button>
        </div>
        <div class="preview-column">
            <h2>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
            <video id="videoPreview" controls></video>
            <div class="virtual-player-container" id="virtual-player">
                <div class="virtual-player-controls">
                    <button id="v-play-btn">‚ñ∂</button>
                    <span id="v-time-display">00:00:00 / 00:00:00</span>
                    <input type="range" id="v-progress-bar" min="0" max="100" value="0">
                </div>
            </div>
            <h2>–õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h2><pre id="log-output">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É...</pre>
        </div>
    </div>
    <div id="file-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3>–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞</h3>
            <div id="path-container">
                <input id="current-path" type="text" value="/">
                <button id="up-btn" title="–í–≤–µ—Ä—Ö">‚Üë</button>
            </div>
            <div id="file-list">(–ø—É—Å—Ç–æ)</div>
            <div class="modal-buttons">
                <button id="close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button id="select-dir-btn" class="hidden" style="background: var(--accent-green);">–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É</button>
            </div>
        </div>
    </div>
    <script>
        const SERVER_PORT = "%%SERVER_PORT%%";
        const logOutput = document.getElementById('log-output');
        let filePaths = { video1: '', video2: '', audio1: '', audio2: '', intro_file: '', output_dir: '' };
        let ws;
        let currentId = '';
        let virtualPlayerState = { isPlaying: false, currentTime: 0, duration: 0, isSeeking: false };
        let timelineMap = []; // –î–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–ª–µ–µ—Ä–∞

        function hmsToSeconds(str) {
            if (!str) return 0;
            const p = str.split(':').map(Number);
            let s = 0;
            if (p.length === 3) s = p[0] * 3600 + p[1] * 60 + p[2];
            else if (p.length === 2) s = p[0] * 60 + p[1];
            else if (p.length === 1 && str) s = parseFloat(str);
            return isNaN(s) ? 0 : s;
        }
        function secondsToHMS(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = Math.floor(s % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        function jumpToTime(id) {
            const input = document.getElementById(id);
            const time = hmsToSeconds(input.value);
            const video = document.getElementById('videoPreview');
            if (!isNaN(time) && video.duration) {
                video.currentTime = time;
                video.play();
            }
        }

        function connect() {
            ws = new WebSocket(`ws://127.0.0.1:${SERVER_PORT}`);
            ws.onopen = () => { 
                console.log('WS –æ—Ç–∫—Ä—ã—Ç');
                logOutput.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.\n'; 
            };
            ws.onerror = (err) => { 
                console.error('WS –æ—à–∏–±–∫–∞:', err);
                logOutput.textContent += '–û—à–∏–±–∫–∞ WS. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç.\n'; 
            };
            ws.onclose = () => { 
                console.log('WS –∑–∞–∫—Ä—ã—Ç');
                setTimeout(connect, 2000); 
            };
            ws.onmessage = (event) => {
                console.log('WS —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ:', event.data);
                const data = JSON.parse(event.data);
                console.log('–ü–∞—Ä—Å: action=', data.action, 'entries length=', data.entries ? data.entries.length : 'no entries');

                if (data.action === 'browse_result') {
                    renderBrowser(data);
                } else if (data.action === 'path_resolved') {
                    if (data.full_path) {
                        filePaths[currentId] = data.full_path;
                        document.getElementById(currentId + '_path').textContent = data.full_path;
                        if (currentId === 'video1' || currentId === 'video2') {
                            document.getElementById('videoPreview').src = data.preview_mode === 'http' ? `http://127.0.0.1:${SERVER_PORT}/video?file=${encodeURIComponent(data.relative_path)}` : 'file://' + data.full_path;
                        }
                        if (currentId === 'output_dir') {
                            document.getElementById('output_dir_path').textContent = data.full_path;
                        }
                    }
                    document.getElementById('file-modal').classList.add('hidden');
                    document.getElementById('select-dir-btn').classList.add('hidden');
                } else if (data.action === 'error') {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data.message);
                    document.getElementById('file-list').innerHTML = `<div style="color: red; padding: 10px;">–û—à–∏–±–∫–∞: ${data.message}</div>`;
                } else if (data.action === 'log') {
                    if (data.message.startsWith('frame=')) {
                        const lines = logOutput.textContent.split('\n');
                        if (lines.length > 1 && lines[lines.length - 2].startsWith('frame=')) {
                            lines[lines.length - 2] = data.message;
                            logOutput.textContent = lines.join('\n');
                        } else {
                            logOutput.textContent += data.message + '\n';
                        }
                    } else {
                        logOutput.textContent += data.message + '\n';
                    }
                    logOutput.scrollTop = logOutput.scrollHeight;
                } else if (data.action === 'finished') {
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').textContent = '–ù–∞—á–∞—Ç—å –û–±—Ä–∞–±–æ—Ç–∫—É';
                } else if (data.action === 'preview_map_ready') {
                    timelineMap = data.timeline_map;
                    virtualPlayerState.duration = data.total_duration;
                    document.getElementById('v-progress-bar').max = data.total_duration;
                    document.getElementById('v-time-display').textContent = `00:00:00 / ${secondsToHMS(data.total_duration)}`;
                    showVirtualPlayer();
                }
            };
        }

        function sendMessage(action, path) {
            console.log(`–û—Ç–ø—Ä–∞–≤–∫–∞: ${action} –¥–ª—è ${path}`);
            ws.send(JSON.stringify({ action, path }));
        }

        function renderBrowser(data) {
            console.log('renderBrowser –≤—ã–∑–≤–∞–Ω, entries:', data.entries ? data.entries.length : 0);
            const fileList = document.getElementById('file-list');
            const pathInput = document.getElementById('current-path');
            
            pathInput.value = data.path;
            
            fileList.innerHTML = '(–∑–∞–≥—Ä—É–∑–∫–∞...)';
            
            let html = '';
            const path = data.path;
            const entries = data.entries || [];
            
            if (path !== '/') {
                const parentPath = path.substring(0, path.lastIndexOf('/')) || '/';
                html += `<div class="file-entry dir" data-path="${parentPath}">.. (–ù–∞–≤–µ—Ä—Ö)</div>`;
            }
            
            html += entries.map(e => {
                if (!e || !e.name) return '';
                const fullPath = (path === '/' ? '' : path) + '/' + e.name;
                return `<div class="file-entry ${e.type || 'file'}" data-path="${fullPath}">${e.name}</div>`;
            }).join('');
            
            fileList.innerHTML = html || '(–ø—É—Å—Ç–æ)';
            console.log('–†–µ–Ω–¥–µ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω, HTML length:', html.length);
        }

        function goUp() {
            const pathInput = document.getElementById('current-path');
            let currentPath = pathInput.value;
            if (currentPath !== '/') {
                const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/')) || '/';
                sendMessage('browse_path', parentPath);
            }
        }

        function openModal(id) {
            currentId = id;
            console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –¥–ª—è', id);
            document.getElementById('file-modal').classList.remove('hidden');
            document.getElementById('file-list').innerHTML = '(–∑–∞–≥—Ä—É–∑–∫–∞...)';
            sendMessage('browse_path', '/');
        }

        function selectFile(id) {
            if (!ws || ws.readyState !== WebSocket.OPEN) { 
                console.error('WS –Ω–µ –≥–æ—Ç–æ–≤');
                logOutput.textContent += '\n–û—à–∏–±–∫–∞: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.\n'; return; 
            }
            document.getElementById('select-dir-btn').classList.add('hidden');
            openModal(id);
        }

        function selectDirectory(id) {
            document.getElementById('select-dir-btn').classList.remove('hidden');
            openModal(id);
        }

        function toggleMode() {
            const isSingleFileMode = document.getElementById('singleFile').checked;
            const isSingleSegmentMode = document.getElementById('is_single_segment').checked;
            
            document.getElementById('video2_container').style.display = isSingleFileMode ? 'none' : 'block';
            document.getElementById('audio2_container').style.display = isSingleFileMode ? 'none' : 'block';
            document.getElementById('single_segment_toggle_div').style.display = isSingleFileMode ? 'block' : 'none';
            
            const showSecondTimecodes = !isSingleFileMode || (isSingleFileMode && !isSingleSegmentMode);
            document.getElementById('part2_timecodes').style.display = showSecondTimecodes ? 'block' : 'none';

            saveState(); 
        }

        function submitForm() {
            if (!ws || ws.readyState !== WebSocket.OPEN) { logOutput.textContent += '\n–û—à–∏–±–∫–∞: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.\n'; return; }
            if (!filePaths.video1) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –í–∏–¥–µ–æ 1"); return; }
            
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            logOutput.textContent = '–ó–∞–ø—É—Å–∫–∞–µ–º...\n';
            
            const params = {
                use_ram: document.getElementById('use_ram').checked,
                mode: document.querySelector('input[name="mode"]:checked').value,
                is_single_segment: document.getElementById('is_single_segment').checked,
                intro_resolution: document.querySelector('input[name="intro_resolution"]:checked').value,
                start1: document.getElementById('start1').value, end1: document.getElementById('end1').value,
                start2: document.getElementById('start2').value, end2: document.getElementById('end2').value,
                output_dir: filePaths.output_dir,
                ...filePaths
            };
            ws.send(JSON.stringify({ action: 'process', params: params }));
        }

        // –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏
        function showVirtualPlayer() {
            document.getElementById('virtual-player').style.display = 'block';
        }

        function handleVirtualPlayPause() {
            const video = document.getElementById('videoPreview');
            if (virtualPlayerState.isPlaying) {
                video.pause();
                virtualPlayerState.isPlaying = false;
                document.getElementById('v-play-btn').textContent = '‚ñ∂';
            } else {
                const globalTime = parseFloat(document.getElementById('v-progress-bar').value);
                seekToGlobalTime(globalTime);
                video.play();
                virtualPlayerState.isPlaying = true;
                document.getElementById('v-play-btn').textContent = '‚è∏';
            }
        }

        function handleVirtualSeek(event) {
            const globalTime = parseFloat(event.target.value);
            virtualPlayerState.currentTime = globalTime;
            updateTimeDisplay();
            if (!virtualPlayerState.isSeeking) {
                seekToGlobalTime(globalTime);
            }
        }

        function seekToGlobalTime(globalTime) {
            const segment = timelineMap.find(s => globalTime >= s.timeline_start && globalTime < s.timeline_start + s.duration);
            if (segment) {
                const localTime = globalTime - segment.timeline_start + segment.source_start_time;
                document.getElementById('videoPreview').currentTime = localTime;
                document.getElementById('videoPreview').src = segment.preview_mode === 'http' ? `http://127.0.0.1:${SERVER_PORT}/video?file=${encodeURIComponent(segment.relative_path)}&start=${localTime}` : 'file://' + segment.source_file;
            }
        }

        function updateTimeDisplay() {
            document.getElementById('v-time-display').textContent = `${secondsToHMS(virtualPlayerState.currentTime)} / ${secondsToHMS(virtualPlayerState.duration)}`;
            document.getElementById('v-progress-bar').value = virtualPlayerState.currentTime;
        }

        function onVideoTimeUpdate() {
            if (virtualPlayerState.isPlaying && !virtualPlayerState.isSeeking) {
                const video = document.getElementById('videoPreview');
                const globalTime = timelineMap.find(s => video.currentTime >= s.source_start_time && video.currentTime < s.source_start_time + s.duration)?.timeline_start + (video.currentTime - s.source_start_time) || 0;
                virtualPlayerState.currentTime = globalTime;
                updateTimeDisplay();
            }
        }

        function saveState() {
            const state = {
                filePaths,
                start1: document.getElementById('start1').value,
                end1: document.getElementById('end1').value,
                start2: document.getElementById('start2').value,
                end2: document.getElementById('end2').value,
                mode: document.querySelector('input[name="mode"]:checked').value,
                is_single_segment: document.getElementById('is_single_segment').checked,
                use_ram: document.getElementById('use_ram').checked,
                intro_resolution: document.querySelector('input[name="intro_resolution"]:checked').value
            };
            localStorage.setItem('videoEditorState', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('videoEditorState');
            if (saved) {
                const state = JSON.parse(saved);
                filePaths = { ...filePaths, ...state.filePaths };
                Object.entries({ start1: 'start1', end1: 'end1', start2: 'start2', end2: 'end2' }).forEach(([key, id]) => {
                    document.getElementById(id).value = state[key] || '';
                });
                document.querySelector(`input[name="mode"][value="${state.mode || 'single'}"]`).checked = true;
                document.getElementById('is_single_segment').checked = state.is_single_segment || false;
                document.getElementById('use_ram').checked = state.use_ram !== false;
                document.querySelector(`input[name="intro_resolution"][value="${state.intro_resolution || '2k'}"]`).checked = true;
                Object.keys(filePaths).forEach(key => {
                    if (filePaths[key]) {
                        document.getElementById(key + '_path').textContent = filePaths[key];
                    }
                });
                if (filePaths.video1 || filePaths.video2) {
                    document.getElementById('videoPreview').src = 'file://' + (filePaths.video1 || filePaths.video2);
                }
            }
        }

        window.onload = () => {
            connect();
            loadState(); 
            toggleMode();

            document.querySelectorAll('input[type="text"]').forEach(input => {
                input.addEventListener('input', saveState); 
            });
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
                input.addEventListener('change', saveState);
            });

            document.getElementById('close-btn').onclick = () => document.getElementById('file-modal').classList.add('hidden');
            document.getElementById('up-btn').onclick = goUp;
            document.getElementById('select-dir-btn').onclick = () => {
                const path = document.getElementById('current-path').value;
                sendMessage('resolve_path', path);
            };
            document.getElementById('current-path').onkeydown = (e) => { if (e.key === 'Enter') sendMessage('browse_path', e.target.value); };
            
            document.getElementById('file-list').onclick = (e) => {
                const target = e.target.closest('.file-entry');
                if (!target) return;
                const path = target.dataset.path;
                const isDir = target.classList.contains('dir');
                if (isDir) {
                    sendMessage('browse_path', path);
                } else if (!document.getElementById('select-dir-btn').classList.contains('hidden')) {
                    return;
                } else {
                    sendMessage('resolve_path', path);
                }
            };

            const videoEl = document.getElementById('videoPreview');
            videoEl.addEventListener('loadedmetadata', () => {
                if (timelineMap.length === 0) {
                    ws.send(JSON.stringify({ action: 'generate_preview_map', params: { ...filePaths, start1: document.getElementById('start1').value, end1: document.getElementById('end1').value, start2: document.getElementById('start2').value, end2: document.getElementById('end2').value } }));
                }
            });
            videoEl.addEventListener('timeupdate', onVideoTimeUpdate);
            videoEl.addEventListener('ended', () => {
                virtualPlayerState.isPlaying = false;
                document.getElementById('v-play-btn').textContent = '‚ñ∂';
            });
        };
    </script>
</body>
</html>